{% extends "dashboard_base.html" %}

{% block page_title %}订单日历{% endblock %}

{% block extra_css %}
<style>
    .calendar-container {
        background: var(--white-color);
        border-radius: 25px;
        padding: 30px;
        box-shadow: 0 4px 18px 0 rgba(75, 70, 92, 0.1);
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #E6EFF5;
    }

    .calendar-nav {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .nav-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 12px;
        background: var(--light-color);
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 16px;
    }

    .nav-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
    }

    .calendar-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--dark-color);
        margin: 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #E6EFF5;
        border-radius: 15px;
        overflow: hidden;
    }

    .calendar-day-header {
        background: var(--light-color);
        padding: 15px 10px;
        text-align: center;
        font-weight: 600;
        color: var(--secondary-color);
        font-size: 14px;
    }

    .calendar-day {
        background: var(--white-color);
        min-height: 120px;
        padding: 10px;
        position: relative;
        transition: all 0.3s ease;
    }

    .calendar-day:hover {
        background: rgba(24, 20, 243, 0.02);
    }

    .calendar-day.other-month {
        background: #F8F9FA;
        color: #ADB5BD;
    }

    .calendar-day.today {
        background: rgba(24, 20, 243, 0.1);
        border: 2px solid var(--primary-color);
    }

    .day-number {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 8px;
        color: var(--dark-color);
    }

    .day-orders {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .order-item {
        background: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .order-item:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(24, 20, 243, 0.3);
    }

    .order-item.urgent {
        background: var(--warning-color);
    }

    .order-item.very-urgent {
        background: var(--danger-color);
        animation: pulse 2s infinite;
    }

    .order-item.completed {
        background: var(--success-color);
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    .legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #E6EFF5;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--secondary-color);
    }

    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }

    .stats-row {
        margin-bottom: 30px;
    }

    .stat-card-small {
        background: var(--white-color);
        border-radius: 20px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 4px 18px 0 rgba(75, 70, 92, 0.1);
        transition: all 0.3s ease;
    }

    .stat-card-small:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px 0 rgba(75, 70, 92, 0.15);
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .stat-number.primary { color: var(--primary-color); }
    .stat-number.warning { color: var(--warning-color); }
    .stat-number.danger { color: var(--danger-color); }
    .stat-number.success { color: var(--success-color); }

    .stat-label {
        color: var(--secondary-color);
        font-size: 14px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<!-- 月度统计 -->
<div class="stats-row">
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card-small">
                <div class="stat-number primary">{{ current_month_orders|length }}</div>
                <div class="stat-label">本月订单</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card-small">
                <div class="stat-number warning">{{ urgent_orders|length }}</div>
                <div class="stat-label">紧急订单</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card-small">
                <div class="stat-number danger">{{ overdue_orders|length }}</div>
                <div class="stat-label">逾期订单</div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card-small">
                <div class="stat-number success">{{ completed_orders|length }}</div>
                <div class="stat-label">已完成</div>
            </div>
        </div>
    </div>
</div>

<!-- 日历 -->
<div class="calendar-container">
    <div class="calendar-header">
        <div class="calendar-nav">
            <button class="nav-btn" onclick="previousMonth()">
                <i class="bi bi-chevron-left"></i>
            </button>
            <h2 class="calendar-title" id="calendarTitle">{{ current_date.strftime('%Y年%m月') }}</h2>
            <button class="nav-btn" onclick="nextMonth()">
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
        <button class="btn btn-primary" onclick="goToToday()">
            <i class="bi bi-calendar-today"></i> 今天
        </button>
    </div>

    <div class="calendar-grid" id="calendarGrid">
        <div class="calendar-day-header">周日</div>
        <div class="calendar-day-header">周一</div>
        <div class="calendar-day-header">周二</div>
        <div class="calendar-day-header">周三</div>
        <div class="calendar-day-header">周四</div>
        <div class="calendar-day-header">周五</div>
        <div class="calendar-day-header">周六</div>
        <!-- 日历日期将通过JavaScript动态生成 -->
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: var(--primary-color);"></div>
            <span>正常订单</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--warning-color);"></div>
            <span>紧急订单 (≤7天)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--danger-color);"></div>
            <span>非常紧急 (≤3天)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--success-color);"></div>
            <span>已完成</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 订单数据
const orders = {{ orders_json|safe }};
let currentDate = new Date();

// 生成日历
function generateCalendar(year, month) {
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const calendarGrid = document.getElementById('calendarGrid');
    const title = document.getElementById('calendarTitle');
    
    // 更新标题
    title.textContent = `${year}年${String(month + 1).padStart(2, '0')}月`;
    
    // 清除现有日期
    const existingDays = calendarGrid.querySelectorAll('.calendar-day');
    existingDays.forEach(day => day.remove());
    
    // 生成42天（6周）
    for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayElement = createDayElement(date, month);
        calendarGrid.appendChild(dayElement);
    }
}

// 创建日期元素
function createDayElement(date, currentMonth) {
    const dayDiv = document.createElement('div');
    dayDiv.className = 'calendar-day';
    
    // 判断是否为其他月份
    if (date.getMonth() !== currentMonth) {
        dayDiv.classList.add('other-month');
    }
    
    // 判断是否为今天
    const today = new Date();
    if (date.toDateString() === today.toDateString()) {
        dayDiv.classList.add('today');
    }
    
    // 日期数字
    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = date.getDate();
    dayDiv.appendChild(dayNumber);
    
    // 订单容器
    const ordersContainer = document.createElement('div');
    ordersContainer.className = 'day-orders';
    
    // 查找当天的订单
    const dateStr = date.toISOString().split('T')[0];
    const dayOrders = orders.filter(order => order.needed_date === dateStr);
    
    // 添加订单
    dayOrders.forEach(order => {
        const orderElement = document.createElement('div');
        orderElement.className = 'order-item';
        orderElement.textContent = `${order.cn} - ${order.character}`;
        orderElement.title = `${order.cn} - ${order.character}\n状态: ${order.status}\n平台: ${order.contact}`;
        
        // 根据紧急程度设置样式
        const daysLeft = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
        if (order.status === '已完成' || order.status === '已发货') {
            orderElement.classList.add('completed');
        } else if (daysLeft < 0) {
            orderElement.classList.add('very-urgent');
        } else if (daysLeft <= 3) {
            orderElement.classList.add('very-urgent');
        } else if (daysLeft <= 7) {
            orderElement.classList.add('urgent');
        }
        
        // 点击跳转到编辑页面
        orderElement.onclick = () => {
            window.location.href = `/edit/${order.id}`;
        };
        
        ordersContainer.appendChild(orderElement);
    });
    
    dayDiv.appendChild(ordersContainer);
    return dayDiv;
}

// 导航函数
function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

function goToToday() {
    currentDate = new Date();
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
}

// 页面加载完成后初始化日历
document.addEventListener('DOMContentLoaded', function() {
    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
});
</script>
{% endblock %}