{% extends "base.html" %}

{% block title %}编辑订单 - 07妙妙屋{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="bi bi-pencil"></i> 编辑订单 - {{ order.cn }}</h4>
                <span class="iconfont icon-weixin"></span>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cn" class="form-label">CN (Coser Name) <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="cn" name="cn" value="{{ order.cn }}" required>
                                <div class="form-text">客户的Coser名称</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="character" class="form-label">动漫角色 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="character" name="character" value="{{ order.character }}" required>
                                <div class="form-text">需要制作的角色名称</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact" class="form-label">平台 <span class="text-danger">*</span></label>
                                <select class="form-select contact-select" id="contact" name="contact" required onchange="updateSelectColors()">
                                    <option value="QQ" {{ 'selected' if order.contact == 'QQ' }}> QQ</option>
                                    <option value="微信" {{ 'selected' if order.contact == '微信' }}> 微信</option>
                                    <option value="闲鱼" {{ 'selected' if order.contact == '闲鱼' }}> 闲鱼</option>     
                                </select>
                                <div class="form-text">客户使用的联系平台</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="final_amount" class="form-label">尾款金额 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="final_amount" name="final_amount" step="0.01" min="0" value="{{ order.final_amount }}" required>
                                </div>
                                <div class="form-text">客户需要支付的尾款金额</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="needed_date" class="form-label">客户排单 <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="needed_date" name="needed_date" value="{{ order.needed_date.strftime('%Y-%m-%d') }}" required>
                                <div class="form-text">客户希望收到假发的日期</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="order_date" class="form-label">ddl <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="order_date" name="order_date" value="{{ order.order_date.strftime('%Y-%m-%d') }}" required>
                                <div class="form-text">客户下单的日期</div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="shipping_included" class="form-label">尾款是否含邮</label>
                                <select class="form-select shipping-select" id="shipping_included" name="shipping_included" required onchange="updateSelectColors()">
                                    <option value="true" {{ 'selected' if order.shipping_included else '' }}>是</option>
                                    <option value="false" {{ 'selected' if not order.shipping_included else '' }}>否</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cake_box" class="form-label">蛋糕盒</label>
                                <select class="form-select cake-box-select" id="cake_box" name="cake_box" onchange="updateSelectColors()">
                                    <option value="不需要" {{ 'selected' if order.cake_box == '不需要' }}>不需要</option>
                                    <option value="需要" {{ 'selected' if order.cake_box == '需要' }}>需要</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">订单状态</label>
                                <select class="form-select status-select" id="status" name="status" onchange="updateSelectColors()">
                                    <option value="待制作" {{ 'selected' if order.status == '待制作' }}>待制作</option>
                                    <option value="制作中" {{ 'selected' if order.status == '制作中' }}>制作中</option>
                                    <option value="已完成" {{ 'selected' if order.status == '已完成' }}>已完成</option>
                                    <option value="已发货" {{ 'selected' if order.status == '已发货' }}>已发货</option>
                                    <option value="已取消" {{ 'selected' if order.status == '已取消' }}>已取消</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deposit_paid" class="form-label">定金状态</label>
                                <select class="form-select deposit-select" id="deposit_paid" name="deposit_paid" onchange="updateSelectColors()">
                                    <option value="false" {{ 'selected' if not order.deposit_paid else '' }}>未付</option>
                                    <option value="true" {{ 'selected' if order.deposit_paid else '' }}>已付</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="blank_purchased" class="form-label">毛坯状态</label>
                                <select class="form-select blank-select" id="blank_purchased" name="blank_purchased" onchange="updateSelectColors()">
                                    <option value="false" {{ 'selected' if not order.blank_purchased else '' }}>未购</option>
                                    <option value="true" {{ 'selected' if order.blank_purchased else '' }}>已购</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 订单信息摘要 -->
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> 订单信息</h6>
                        <p class="mb-1"><strong>创建时间：</strong>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p class="mb-0"><strong>订单ID：</strong>#{{ order.id }}</p>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="bi bi-arrow-left"></i> 返回列表
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> 保存更改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 更新下拉选择框颜色
function updateSelectColors() {
    // 平台颜色
    const contactSelect = document.querySelector('.contact-select');
    if (contactSelect) {
        contactSelect.className = contactSelect.className.replace(/\b(qq|wechat|xianyu)\b/g, '');
        const contactValue = contactSelect.value;
        if (contactValue === 'QQ') {
            contactSelect.classList.add('qq');
        } else if (contactValue === '微信') {
            contactSelect.classList.add('wechat');
        } else if (contactValue === '闲鱼') {
            contactSelect.classList.add('xianyu');
        }
    }
    
    // 含邮颜色
    const shippingSelect = document.querySelector('.shipping-select');
    if (shippingSelect) {
        shippingSelect.classList.remove('included', 'not-included');
        const shippingValue = shippingSelect.value;
        if (shippingValue === 'true') {
            shippingSelect.classList.add('included');
        } else if (shippingValue === 'false') {
            shippingSelect.classList.add('not-included');
        }
    }
    
    // 定金颜色
    const depositSelect = document.querySelector('.deposit-select');
    if (depositSelect) {
        depositSelect.classList.remove('paid', 'unpaid');
        const depositValue = depositSelect.value;
        if (depositValue === 'true') {
            depositSelect.classList.add('paid');
        } else if (depositValue === 'false') {
            depositSelect.classList.add('unpaid');
        }
    }
    
    // 毛坯颜色
    const blankSelect = document.querySelector('.blank-select');
    if (blankSelect) {
        blankSelect.classList.remove('purchased', 'unpurchased');
        const blankValue = blankSelect.value;
        if (blankValue === 'true') {
            blankSelect.classList.add('purchased');
        } else if (blankValue === 'false') {
            blankSelect.classList.add('unpurchased');
        }
    }
    
    // 蛋糕盒颜色
    const cakeBoxSelect = document.querySelector('.cake-box-select');
    if (cakeBoxSelect) {
        cakeBoxSelect.classList.remove('needed', 'not-needed');
        const cakeBoxValue = cakeBoxSelect.value;
        if (cakeBoxValue === '需要') {
            cakeBoxSelect.classList.add('needed');
        } else if (cakeBoxValue === '不需要') {
            cakeBoxSelect.classList.add('not-needed');
        }
    }
    
    // 状态颜色
    const statusSelect = document.querySelector('.status-select');
    if (statusSelect) {
        statusSelect.classList.remove('pending', 'in-progress', 'completed', 'shipped', 'cancelled');
        const statusValue = statusSelect.value;
        if (statusValue === '待制作') {
            statusSelect.classList.add('pending');
        } else if (statusValue === '制作中') {
            statusSelect.classList.add('in-progress');
        } else if (statusValue === '已完成') {
            statusSelect.classList.add('completed');
        } else if (statusValue === '已发货') {
            statusSelect.classList.add('shipped');
        } else if (statusValue === '已取消') {
            statusSelect.classList.add('cancelled');
        }
    }
}

// 页面加载完成后初始化颜色
document.addEventListener('DOMContentLoaded', function() {
    updateSelectColors();
});

// 表单验证
document.querySelector('form').addEventListener('submit', function(e) {
    const neededDate = new Date(document.getElementById('needed_date').value);
    const orderDate = new Date(document.getElementById('order_date').value);
    
    // if (neededDate < orderDate) {
    //     e.preventDefault();
    //     alert('客户排单不能早于ddl！');
    //     return false;
    // }
});

// 状态变更提醒
document.getElementById('status').addEventListener('change', function() {
    const status = this.value;
    if (status === '已完成' || status === '已发货') {
        const depositSelect = document.getElementById('deposit_paid');
        if (depositSelect && depositSelect.value === 'false') {
            if (confirm('订单状态为已完成/已发货，是否同时标记定金为已支付？')) {
                depositSelect.value = 'true';
                updateSelectColors();
            }
        }
    }
});
</script>
{% endblock %}