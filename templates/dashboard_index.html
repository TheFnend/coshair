<!--
07妙妙屋订单管理系统 - 主页面

功能模块：
1. 背景设置面板 - 自定义页面背景图片和透明度
2. 订单统计卡片 - 显示各类订单数量和金额统计
3. 图例说明 - 订单紧急程度和状态的颜色说明
4. 筛选和排序 - 按状态、紧急程度等条件筛选订单
5. 订单列表表格 - 显示所有订单详细信息
6. 批量操作 - 支持批量删除等操作
-->
{% extends "dashboard_base.html" %}

{% block title %}订单列表 - 07妙妙屋{% endblock %}

{% block page_title %}订单列表{% endblock %}

{% block extra_css %}
<style>
/* ==================== 订单行背景色样式 ==================== */

/* 表格内容居中 */
.table tbody td {
    text-align: center !important;
    vertical-align: middle !important;
}

.table thead th {
    text-align: center !important;
    vertical-align: middle !important;
}

/* 按钮圆角 */
.btn {
    border-radius: 8px !important;
}

/* 下拉框圆角样式 */
.form-select {
    border-radius: 8px !important;
}

/* 修复鼠标悬停时保持原有颜色 */
.table tbody tr:hover {
    background-color: inherit !important;
}

.table tbody tr:hover td {
    color: inherit !important;
}

.table tbody tr.expired:hover {
    background-color: inherit !important;
}

.table tbody tr.expired:hover td {
    color: inherit !important;
}

.table tbody tr.very-urgent:hover {
    background-color: inherit !important;
}

.table tbody tr.very-urgent:hover td {
    color: inherit !important;
}

.table tbody tr.urgent:hover {
    background-color: inherit !important;
}

.table tbody tr.urgent:hover td {
    color: inherit !important;
}

.table tbody tr.completed:hover {
    background-color: inherit !important;
}

.table tbody tr.completed:hover td {
    color: inherit !important;
}

.table tbody tr.shipped:hover {
    background-color: inherit !important;
}

.table tbody tr.shipped:hover td {
    color: inherit !important;
}

.table tbody tr.overdue:hover {
    background-color: inherit !important;
}

.table tbody tr.overdue:hover td {
    color: inherit !important;
}

/* 逾期订单 - 红色背景 */
.table tbody tr.expired:nth-child(even) {
    background-color: rgba(220, 53, 69, 0.8) !important;
    color: white !important;
}

.table tbody tr.expired:nth-child(odd) {
    background-color: rgba(220, 53, 69, 0.8) !important;
    color: white !important;
}

/* 三天内订单 - 淡红色背景斑马线 */
.table tbody tr.very-urgent:nth-child(even) {
    background-color: rgba(248, 215, 218, 0.8) !important;
    color: #721c24 !important;
}

.table tbody tr.very-urgent:nth-child(odd) {
    background-color: rgba(248, 215, 218, 0.8) !important;
    color: #721c24 !important;
}

/* 七天内订单 - 淡黄色背景斑马线 */
.table tbody tr.urgent:nth-child(even) {
    background-color: rgba(255, 243, 205, 0.8) !important;
    color: #856404 !important;
}

.table tbody tr.urgent:nth-child(odd) {
    background-color: rgba(255, 243, 205, 0.8) !important;
    color: #856404 !important;
}

/* 已完成订单 - 浅绿色背景斑马线 */
.table tbody tr.completed:nth-child(even) {
    background-color: rgba(212, 237, 218, 0.8) !important;
    color: #155724 !important;
}

.table tbody tr.completed:nth-child(odd) {
    background-color: rgba(212, 237, 218, 0.8) !important;
    color: #155724 !important;
}

/* 已发货订单 - 淡蓝色背景斑马线 */
.table tbody tr.shipped:nth-child(even) {
    background-color: rgba(209, 236, 241, 0.8) !important;
    color: #0c5460 !important;
}

.table tbody tr.shipped:nth-child(odd) {
    background-color: rgba(209, 236, 241, 0.8) !important;
    color: #0c5460 !important;
}

/* 其他订单 - 默认白色背景 */
.table tbody tr.overdue:nth-child(even) {
    background-color: rgba(255, 255, 255, 0.8) !important;
    color: #333 !important;
}

.table tbody tr.overdue:nth-child(odd) {
    background-color: rgba(248, 249, 250, 0.8) !important;
    color: #333 !important;
}

/* ==================== 下拉选择框颜色样式 ==================== */

/* 定金状态选项颜色 */
.deposit-select option[value="true"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.deposit-select option[value="false"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}

/* 平台选择框选项颜色 */
.contact-select option[value="QQ"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}
.contact-select option[value="微信"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.contact-select option[value="闲鱼"] {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

/* 订单状态选项颜色 */
.status-select option[value="待制作"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}
.status-select option[value="制作中"] {
    background-color: #fff3cd !important;
    color: #856404 !important;
}
.status-select option[value="已完成"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.status-select option[value="已发货"] {
    background-color: #d1ecf1 !important;
    color: #0c5460 !important;
}
.status-select option[value="已取消"] {
    background-color: #f5c6cb !important;
    color: #721c24 !important;
}

/* 蛋糕盒选项颜色 */
.cake-box-select option[value="不需要"] {
    background-color: #e2e3e5 !important;
    color: #495057 !important;
}
.cake-box-select option[value="需要"] {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

/* 毛坯状态颜色 */
.blank-select option[value="true"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.blank-select option[value="false"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}

/* 含邮状态颜色 */
.shipping-select option[value="true"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.shipping-select option[value="false"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}

/* 平台选择框颜色 */
.contact-select option[value="QQ"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}
.contact-select option[value="微信"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.contact-select option[value="闲鱼"] {
    background-color: #fff3cd !important;
    color: #856404 !important;
}

/* 状态选择框颜色 */
.status-select option[value="待制作"] {
    background-color: #f8d7da !important;
    color: #721c24 !important;
}
.status-select option[value="制作中"] {
    background-color: #fff3cd !important;
    color: #856404 !important;
}
.status-select option[value="已完成"] {
    background-color: #d4edda !important;
    color: #155724 !important;
}
.status-select option[value="已发货"] {
    background-color: #d1ecf1 !important;
    color: #0c5460 !important;
}
.status-select option[value="已取消"] {
    background-color: #f5c6cb !important;
    color: #721c24 !important;
}

/* 蛋糕盒选择框颜色 */
.cake-box-select option[value="需要"] {
    background-color: #fff3cd !important;
    color: #856404 !important;
}
.cake-box-select option[value="不需要"] {
    background-color: #e2e3e5 !important;
    color: #495057 !important;
}

/* 选择框根据选中值的背景色 */
.deposit-select {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}
.deposit-select[value="true"] {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}

.blank-select {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}
.blank-select[value="true"] {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}

.shipping-select {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}
.shipping-select[value="true"] {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}

.contact-select {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}
.contact-select[value="微信"] {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}
.contact-select[value="闲鱼"] {
    background-color: #fff3cd !important;
    border-color: #ffc107 !important;
    color: #856404 !important;
}

.status-select {
    background-color: #f8d7da !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}
.status-select[value="制作中"] {
    background-color: #fff3cd !important;
    border-color: #ffc107 !important;
    color: #856404 !important;
}
.status-select[value="已完成"] {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    color: #155724 !important;
}
.status-select[value="已发货"] {
    background-color: #d1ecf1 !important;
    border-color: #17a2b8 !important;
    color: #0c5460 !important;
}
.status-select[value="已取消"] {
    background-color: #f5c6cb !important;
    border-color: #dc3545 !important;
    color: #721c24 !important;
}

.cake-box-select {
    background-color: #e2e3e5 !important;
    border-color: #6c757d !important;
    color: #495057 !important;
}
.cake-box-select[value="需要"] {
    background-color: #fff3cd !important;
    border-color: #ffc107 !important;
    color: #856404 !important;
}
</style>
{% endblock %}

{% block content %}



<!-- ==================== 订单统计卡片 ==================== -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card" style="background: rgba(78, 171, 144, 0.85); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white;">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-list-ul" style="font-size: 2.5rem;"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|length }}</h5>
                    <p class="stats-label mb-0">总订单数</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card" style="background: rgba(142, 162, 156, 0.85); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white;">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-cash-coin" style="font-size: 2.5rem;"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('deposit_paid')|list|length }}</h5>
                    <p class="stats-label mb-0">已付定金</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card" style="background: rgba(237, 221, 195, 0.85); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: #333;">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3" style="font-size: 2.5rem;">
                    <i class="bi bi-currency-yen"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">¥{{ "%.0f"|format(orders|sum(attribute='final_amount')) }}</h5>
                    <p class="stats-label mb-0">总金额</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card" style="background: rgba(238, 191, 109, 0.85); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white;">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3" style="font-size: 2.5rem;">
                    <i class="bi bi-box"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('blank_purchased')|list|length }}</h5>
                    <p class="stats-label mb-0">已购毛坯</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card" style="background: rgba(217, 79, 51, 0.85); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white;">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3" style="font-size: 2.5rem;">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('status', 'equalto', '待制作')|list|length }}</h5>
                    <p class="stats-label mb-0">待制作</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card" style="background: rgba(175, 101, 94, 0.85); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); color: white;">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3" style="font-size: 2.5rem;">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('status', 'in', ['已完成', '已发货'])|list|length }}</h5>
                    <p class="stats-label mb-0">已完成</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选和排序选项控制面板 -->
<div class="card mb-4" style="background: rgba(255, 255, 255, 0.75); border-radius: 15px; backdrop-filter: blur(10px); border: none; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);backdrop-filter: blur(10px);">
    <div class="card-body">
        <!-- 筛选选项 -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="card-title mb-3"><i class="bi bi-funnel"></i> 筛选选项 </h6>
                <div class="row">
                    <div class="col-md-2 mb-2">
                        <label class="form-label">平台</label>
                        <select class="form-select form-select-sm" id="platformFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="QQ" {{ 'selected' if platform_filter == 'QQ' }}><i class="fab fa-qq"></i> QQ</option>
                            <option value="微信" {{ 'selected' if platform_filter == '微信' }}><i class="fab fa-weixin"></i> 微信</option>
                            <option value="闲鱼" {{ 'selected' if platform_filter == '闲鱼' }}><i class="fas fa-fish"></i> 闲鱼</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">定金状态</label>
                        <select class="form-select form-select-sm" id="depositFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="paid">已付</option>
                            <option value="unpaid">未付</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">含邮状态</label>
                        <select class="form-select form-select-sm" id="shippingFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="included">包邮</option>
                            <option value="not-included">不包邮</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">毛坯状态</label>
                        <select class="form-select form-select-sm" id="blankFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="purchased">已购</option>
                            <option value="unpurchased">未购</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">订单状态</label>
                        <select class="form-select form-select-sm" id="statusFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="待制作">待制作</option>
                            <option value="制作中">制作中</option>
                            <option value="已完成">已完成</option>
                            <option value="已发货">已发货</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2 d-flex align-items-end">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                            <i class="bi bi-arrow-clockwise"></i> 清除筛选
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12 text-end">
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="showCompleted" 
                                   onchange="toggleCompleted()">
                            <label class="form-check-label" for="showCompleted">
                                显示已完成订单
                            </label>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" id="toggleBatchModeBtn" onclick="toggleBatchMode()">
                            <i class="bi bi-check-square"></i> 批量操作
                        </button>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display: none;">
                            <i class="bi bi-trash"></i> 批量删除
                        </button>
                        <button class="btn btn-secondary btn-sm" id="cancelBatchModeBtn" onclick="cancelBatchMode()" style="display: none;">
                            <i class="bi bi-x"></i> 取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

    </div>
</div>

<!-- 订单表格 -->
{% if orders %}
<div class="table-container">
    <div class="table-responsive" style="background: rgba(255, 255, 255, 0.75); border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); backdrop-filter: blur(4px);">
        <table class="table table-hover" style="background: transparent; border-radius: 10px; overflow: hidden;">
        <thead>
            <tr  style="font-size: 17px;">
                <th class="checkbox-column" style="width: 50px; display: none;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th style="width: 100px;">CN</th>
                <th style="width: 100px;">角色</th>
                <th style="width: 120px;">平台</th>
                <th style="width: 100px;">排单</th>
                <th style="width: 100px;">ddl</th>
                <th style="width: 100px;">定金</th>
                <th style="width: 100px;">尾款</th>
                <th style="width: 100px;">含邮</th>
                <th style="width: 100px;">毛坯</th>
                <th style="width: 100px;">蛋糕盒</th>
                <th style="width: 100px;">状态</th>
                <th style="width: 100px;">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            {% set days_left = (order.needed_date - today).days if today else 0 %}
            <tr class="{% if order.status == '已完成' %}completed{% elif order.status == '已发货' %}shipped{% elif days_left < 0 and order.status not in ['已完成', '已发货'] %}expired{% elif days_left <= 3 and days_left >= 0 %}very-urgent{% elif days_left <= 7 and days_left >= 0 %}urgent{% else %}overdue{% endif %}">
                <td class="checkbox-column" style="display: none;">
                    <input type="checkbox" class="order-checkbox" value="{{ order.id }}" onchange="updateBatchDeleteBtn()">
                </td>
                <td><strong>{{ order.cn }}</strong></td>
                <td>{{ order.character }}</td>
                <td>
                    <select class="form-select form-select-sm contact-select" onchange="updateOrderField({{ order.id }}, 'contact', this.value); updateSelectColors();">
                        <option value="QQ" {{ 'selected' if order.contact == 'QQ' }}><i class="fab fa-qq"></i> QQ</option>
                        <option value="微信" {{ 'selected' if order.contact == '微信' }}><i class="fab fa-weixin"></i> 微信</option>
                        <option value="闲鱼" {{ 'selected' if order.contact == '闲鱼' }}><i class="fas fa-fish"></i> 闲鱼</option>
                    </select>
                </td>
                <td>
                    {{ order.needed_date.strftime('%Y-%m-%d') }}
                    {% if days_left <= 7 and days_left >= 0 and order.status not in ['已完成', '已发货'] %}
                        <br><small style="color: #fa1818;">还有{{ days_left }}天</small>
                    {% endif %}
                    {% if days_left < 0  and order.status not in ['已完成', '已发货'] %}
                        <br><small style="color: #ffffff;font-weight: 600;font-size: 16px;">逾期{{ days_left|abs }}天</small>
                    {% endif %}
                </td>
                <td>{{ order.order_date.strftime('%Y-%m-%d') }}</td>
                <td>
                    <select class="form-select form-select-sm deposit-select" onchange="updateOrderField({{ order.id }}, 'deposit_paid', this.value === 'true'); updateSelectColors();">
                        <option value="false" {{ 'selected' if not order.deposit_paid }}>未付</option>
                        <option value="true" {{ 'selected' if order.deposit_paid }}>已付</option>
                    </select>
                </td>
                <td>¥{{ "%.2f"|format(order.final_amount) }}</td>
                <td>
                    <select class="form-select form-select-sm shipping-select" onchange="updateOrderField({{ order.id }}, 'shipping_included', this.value === 'true'); updateSelectColors();">
                        <option value="false" {{ 'selected' if not order.shipping_included }}>不含邮</option>
                        <option value="true" {{ 'selected' if order.shipping_included }}>含邮</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm blank-select" onchange="updateOrderField({{ order.id }}, 'blank_purchased', this.value === 'true'); updateSelectColors();">
                        <option value="false" {{ 'selected' if not order.blank_purchased }}>未购</option>
                        <option value="true" {{ 'selected' if order.blank_purchased }}>已购</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm cake-box-select" onchange="updateOrderField({{ order.id }}, 'cake_box', this.value); updateSelectColors();">
                        <option value="不需要" {{ 'selected' if order.cake_box == '不需要' }}>不需要</option>
                        <option value="需要" {{ 'selected' if order.cake_box == '需要' }}>需要</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm status-select" onchange="updateOrderField({{ order.id }}, 'status', this.value); updateSelectColors();">
                        <option value="待制作" {{ 'selected' if order.status == '待制作' }}>待制作</option>
                        <option value="制作中" {{ 'selected' if order.status == '制作中' }}>制作中</option>
                        <option value="已完成" {{ 'selected' if order.status == '已完成' }}>已完成</option>
                        <option value="已发货" {{ 'selected' if order.status == '已发货' }}>已发货</option>
                        <option value="已取消" {{ 'selected' if order.status == '已取消' }}>已取消</option>
                    </select>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{{ url_for('dashboard_edit_order', id=order.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil"></i>
                        </a>
                        &nbsp;
                        <a href="{{ url_for('delete_order', id=order.id) }}" 
                           class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('确定要删除这个订单吗？')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
    <h4 class="mt-3 text-muted">暂无订单</h4>
    <p class="text-muted">点击上方按钮添加第一个订单</p>
</div>
{% endif %}



{% endblock %}

{% block scripts %}
<script>
// 全局变量
let currentDate = new Date();
let batchMode = false;
let orders = {{ orders_json|safe }};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    updateSelectColors();
    
    // 默认隐藏已完成和已发货的订单
    const showCompleted = document.getElementById('showCompleted').checked;
    if (!showCompleted) {
        toggleCompletedOrders(false);
    }
});

// ==================== 背景设置功能（简化版，仅用于加载已保存的背景） ====================

// 页面加载时恢复背景设置
window.addEventListener('load', function() {
    const savedImage = localStorage.getItem('backgroundImage');
    const savedOpacity = localStorage.getItem('backgroundOpacity') || '50';
    
    if (savedImage) {
        const opacityValue = savedOpacity / 100;
        document.documentElement.style.setProperty('--bg-image', `url(${savedImage})`);
        document.documentElement.style.setProperty('--bg-opacity', opacityValue);
    }
});

// ==================== 订单管理功能 ====================

// 更新订单字段
function updateOrderField(orderId, field, value) {
    const data = {};
    data[field] = value;
    
    fetch(`/api/update_order/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('订单更新成功');
            // 更新本地orders数据
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order[field] = value;
            }
            // 更新下拉框颜色
            updateSelectColors();
        } else {
            alert('更新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败');
    });
}

// 更新选择框颜色
function updateSelectColors() {
    // 平台选择框颜色
    document.querySelectorAll('.contact-select').forEach(select => {
        // 移除所有颜色类
        select.className = 'form-select form-select-sm contact-select';
        // 根据选中值设置属性，CSS会根据属性值应用样式
        select.setAttribute('value', select.value);
    });
    
    // 定金状态颜色
    document.querySelectorAll('.deposit-select').forEach(select => {
        select.className = 'form-select form-select-sm deposit-select';
        select.setAttribute('value', select.value);
    });
    
    // 含邮状态颜色
    document.querySelectorAll('.shipping-select').forEach(select => {
        select.className = 'form-select form-select-sm shipping-select';
        select.setAttribute('value', select.value);
    });
    
    // 毛坯状态颜色
    document.querySelectorAll('.blank-select').forEach(select => {
        select.className = 'form-select form-select-sm blank-select';
        select.setAttribute('value', select.value);
    });
    
    // 蛋糕盒状态颜色
    document.querySelectorAll('.cake-box-select').forEach(select => {
        select.className = 'form-select form-select-sm cake-box-select';
        select.setAttribute('value', select.value);
    });
    
    // 订单状态颜色
    document.querySelectorAll('.status-select').forEach(select => {
        select.className = 'form-select form-select-sm status-select';
        select.setAttribute('value', select.value);
    });
}

// ==================== 筛选功能 ====================

// 应用筛选
function applyFilters() {
    const platformFilter = document.getElementById('platformFilter').value;
    const depositFilter = document.getElementById('depositFilter').value;
    const shippingFilter = document.getElementById('shippingFilter').value;
    const blankFilter = document.getElementById('blankFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const showCompleted = document.getElementById('showCompleted').checked;
    
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // 首先检查是否是已完成或已发货订单，如果不显示已完成订单则隐藏
        const isCompletedOrShipped = row.classList.contains('completed') || row.classList.contains('shipped');
        if (isCompletedOrShipped && !showCompleted) {
            show = false;
        }
        
        // 只有在订单应该显示的情况下才进行其他筛选
        if (show) {
            // 平台筛选
            if (platformFilter) {
                const contactSelect = row.querySelector('.contact-select');
                if (contactSelect && contactSelect.value !== platformFilter) {
                    show = false;
                }
            }
            
            // 定金状态筛选
            if (depositFilter) {
                const depositSelect = row.querySelector('.deposit-select');
                if (depositSelect) {
                    const isPaid = depositSelect.value === 'true';
                    if ((depositFilter === 'paid' && !isPaid) || (depositFilter === 'unpaid' && isPaid)) {
                        show = false;
                    }
                }
            }
            
            // 含邮状态筛选
            if (shippingFilter) {
                const shippingSelect = row.querySelector('.shipping-select');
                if (shippingSelect) {
                    const isIncluded = shippingSelect.value === 'true';
                    if ((shippingFilter === 'included' && !isIncluded) || (shippingFilter === 'not-included' && isIncluded)) {
                        show = false;
                    }
                }
            }
            
            // 毛坯状态筛选
            if (blankFilter) {
                const blankSelect = row.querySelector('.blank-select');
                if (blankSelect) {
                    const isPurchased = blankSelect.value === 'true';
                    if ((blankFilter === 'purchased' && !isPurchased) || (blankFilter === 'unpurchased' && isPurchased)) {
                        show = false;
                    }
                }
            }
            
            // 订单状态筛选
            if (statusFilter) {
                const statusSelect = row.querySelector('.status-select');
                if (statusSelect && statusSelect.value !== statusFilter) {
                    show = false;
                }
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// 清除筛选
function clearFilters() {
    document.getElementById('platformFilter').value = '';
    document.getElementById('depositFilter').value = '';
    document.getElementById('shippingFilter').value = '';
    document.getElementById('blankFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    // 重新应用已完成订单的显示状态
    const showCompleted = document.getElementById('showCompleted').checked;
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const isCompletedOrShipped = row.classList.contains('completed') || row.classList.contains('shipped');
        if (isCompletedOrShipped && !showCompleted) {
            row.style.display = 'none';
        } else {
            row.style.display = '';
        }
    });
}

// 切换已完成订单显示
function toggleCompleted() {
    const showCompleted = document.getElementById('showCompleted').checked;
    toggleCompletedOrders(showCompleted);
    
    // 更新URL参数
    const url = new URL(window.location);
    if (showCompleted) {
        url.searchParams.set('show_completed', 'true');
    } else {
        url.searchParams.delete('show_completed');
    }
    window.history.replaceState({}, '', url);
}

// 切换已完成订单显示状态
function toggleCompletedOrders(show) {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        if (row.classList.contains('completed') || row.classList.contains('shipped')) {
            row.style.display = show ? '' : 'none';
        }
    });
}

// ==================== 批量操作功能 ====================

// 切换批量模式
function toggleBatchMode() {
    batchMode = !batchMode;
    const checkboxColumns = document.querySelectorAll('.checkbox-column');
    const toggleBtn = document.getElementById('toggleBatchModeBtn');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const cancelBtn = document.getElementById('cancelBatchModeBtn');
    
    if (batchMode) {
        checkboxColumns.forEach(col => col.style.display = 'table-cell');
        toggleBtn.style.display = 'none';
        batchDeleteBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    } else {
        checkboxColumns.forEach(col => col.style.display = 'none');
        toggleBtn.style.display = 'inline-block';
        batchDeleteBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        // 清除所有选择
        document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
    }
}

// 取消批量模式
function cancelBatchMode() {
    batchMode = false;
    toggleBatchMode();
}

// 全选/取消全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    
    checkboxes.forEach(cb => {
        // 只选择可见的行
        const row = cb.closest('tr');
        if (row.style.display !== 'none') {
            cb.checked = selectAll.checked;
        }
    });
    
    updateBatchDeleteBtn();
}

// 更新批量删除按钮状态
function updateBatchDeleteBtn() {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    
    if (checkedBoxes.length > 0) {
        batchDeleteBtn.textContent = `批量删除 (${checkedBoxes.length})`;
        batchDeleteBtn.disabled = false;
    } else {
        batchDeleteBtn.textContent = '批量删除';
        batchDeleteBtn.disabled = true;
    }
}

// 批量删除
function batchDelete() {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('请选择要删除的订单');
        return;
    }
    
    if (!confirm(`确定要删除选中的 ${checkedBoxes.length} 个订单吗？`)) {
        return;
    }
    
    const orderIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    fetch('/api/batch_delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_ids: orderIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('删除失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('删除失败');
    });
}

// ==================== 编辑订单功能 ====================

// 编辑订单
function editOrder(orderId) {
    window.location.href = `/edit/${orderId}`;
}
</script>
{% endblock %}