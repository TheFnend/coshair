<!--
07妙妙屋订单管理系统 - 主页面

功能模块：
1. 背景设置面板 - 自定义页面背景图片和透明度
2. 订单统计卡片 - 显示各类订单数量和金额统计
3. 图例说明 - 订单紧急程度和状态的颜色说明
4. 筛选和排序 - 按状态、紧急程度等条件筛选订单
5. 订单列表表格 - 显示所有订单详细信息
6. 批量操作 - 支持批量删除等操作
-->
{% extends "dashboard_base.html" %}

{% block title %}订单列表 - 07妙妙屋{% endblock %}

{% block page_title %}订单列表{% endblock %}

{% block content %}

<!-- ==================== 背景设置面板 ==================== -->
<div class="card mb-4" id="backgroundSettings" style="display: none;">
    <div class="card-body">
        <h5 class="card-title"><i class="bi bi-palette"></i> 背景设置</h5>
        <div class="row">
            <!-- 背景图片上传 -->
            <div class="col-md-6">
                <label for="backgroundImage" class="form-label">上传背景图片</label>
                <input type="file" class="form-control" id="backgroundImage" accept="image/*" onchange="handleBackgroundUpload(event)">
            </div>
            <!-- 透明度调节 -->
            <div class="col-md-3">
                <label for="backgroundOpacity" class="form-label">透明度: <span id="opacityValue">50%</span></label>
                <input type="range" class="form-range" id="backgroundOpacity" min="0" max="100" value="50" oninput="updateBackgroundOpacity(this.value)">
            </div>
            <!-- 移除背景按钮 -->
            <div class="col-md-3">
                <button class="btn btn-outline-danger" onclick="removeBackground()">
                    <i class="bi bi-trash"></i> 移除背景
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== 订单统计卡片 ==================== -->
<div class="row mb-4">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card gradient-card-blue">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-list-ul"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|length }}</h5>
                    <p class="stats-label mb-0">总订单数</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card gradient-card-green">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('deposit_paid')|list|length }}</h5>
                    <p class="stats-label mb-0">已付定金</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card gradient-card-orange">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-currency-yen"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">¥{{ "%.0f"|format(orders|sum(attribute='final_amount')) }}</h5>
                    <p class="stats-label mb-0">总金额</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card gradient-card-purple">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-box"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('blank_purchased')|list|length }}</h5>
                    <p class="stats-label mb-0">已购毛坯</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card gradient-card-yellow">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('status', 'equalto', '待制作')|list|length }}</h5>
                    <p class="stats-label mb-0">待制作</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card stats-card gradient-card-teal">
            <div class="card-body d-flex align-items-center">
                <div class="stats-icon me-3">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stats-content">
                    <h5 class="stats-number mb-1">{{ orders|selectattr('status', 'in', ['已完成', '已发货'])|list|length }}</h5>
                    <p class="stats-label mb-0">已完成</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 筛选和排序选项控制面板 -->
<div class="card mb-4">
    <div class="card-body">
        <!-- 筛选选项 -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="card-title mb-3"><i class="bi bi-funnel"></i> 筛选选项 </h6>
                <div class="row">
                    <div class="col-md-2 mb-2">
                        <label class="form-label">平台</label>
                        <select class="form-select form-select-sm" id="platformFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="QQ" {{ 'selected' if platform_filter == 'QQ' }}>QQ</option>
                            <option value="微信" {{ 'selected' if platform_filter == '微信' }}>微信</option>
                            <option value="闲鱼" {{ 'selected' if platform_filter == '闲鱼' }}>闲鱼</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">定金状态</label>
                        <select class="form-select form-select-sm" id="depositFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="paid">已付</option>
                            <option value="unpaid">未付</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">含邮状态</label>
                        <select class="form-select form-select-sm" id="shippingFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="included">包邮</option>
                            <option value="not-included">不包邮</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">毛坯状态</label>
                        <select class="form-select form-select-sm" id="blankFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="purchased">已购</option>
                            <option value="unpurchased">未购</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2">
                        <label class="form-label">订单状态</label>
                        <select class="form-select form-select-sm" id="statusFilter" onchange="applyFilters()">
                            <option value="">全部</option>
                            <option value="待制作">待制作</option>
                            <option value="制作中">制作中</option>
                            <option value="已完成">已完成</option>
                            <option value="已发货">已发货</option>
                            <option value="已取消">已取消</option>
                        </select>
                    </div>
                    <div class="col-md-2 mb-2 d-flex align-items-end">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                            <i class="bi bi-arrow-clockwise"></i> 清除筛选
                        </button>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12 text-end">
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="showCompleted" 
                                   {{ 'checked' if show_completed }} onchange="toggleCompleted()">
                            <label class="form-check-label" for="showCompleted">
                                显示已完成订单
                            </label>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" id="toggleBatchModeBtn" onclick="toggleBatchMode()">
                            <i class="bi bi-check-square"></i> 批量操作
                        </button>
                        <button class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDelete()" style="display: none;">
                            <i class="bi bi-trash"></i> 批量删除
                        </button>
                        <button class="btn btn-secondary btn-sm" id="cancelBatchModeBtn" onclick="cancelBatchMode()" style="display: none;">
                            <i class="bi bi-x"></i> 取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
        

    </div>
</div>

<!-- 订单表格 -->
{% if orders %}
<div class="table-container ">
    <div class="table-responsive" >
        <table class="table table-hover">
        <thead>
            <tr  style="font-size: 17px;">
                <th class="checkbox-column" style="width: 50px; display: none;">
                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th style="width: 80px;">CN</th>
                <th style="width: 100px;">角色</th>
                <th style="width: 120px;">平台</th>
                <th style="width: 100px;">排单</th>
                <th style="width: 100px;">ddl</th>
                <th style="width: 80px;">定金</th>
                <th style="width: 100px;">尾款</th>
                <th style="width: 100px;">含邮</th>
                <th style="width: 100px;">毛坯</th>
                <th style="width: 100px;">蛋糕盒</th>
                <th style="width: 100px;">状态</th>
                <th style="width: 100px;">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            {% set days_left = (order.needed_date - today).days if today else 0 %}
            <tr class="{% if order.status == '已完成' %}completed{% elif order.status == '已发货' %}shipped{% elif days_left < 0 and order.status not in ['已完成', '已发货'] %}expired{% elif days_left <= 3 and days_left >= 0 %}very-urgent{% elif days_left <= 7 and days_left >= 0 %}urgent{% else %}overdue{% endif %}">
                <td class="checkbox-column" style="display: none;">
                    <input type="checkbox" class="order-checkbox" value="{{ order.id }}" onchange="updateBatchDeleteBtn()">
                </td>
                <td><strong>{{ order.cn }}</strong></td>
                <td>{{ order.character }}</td>
                <td>
                    <select class="form-select form-select-sm contact-select" onchange="updateOrderField({{ order.id }}, 'contact', this.value); updateSelectColors();">
                        <option value="QQ" {{ 'selected' if order.contact == 'QQ' }}>&#xf1d6; QQ</option>
                        <option value="微信" {{ 'selected' if order.contact == '微信' }}>&#xf1d7; 微信</option>
                        <option value="闲鱼" {{ 'selected' if order.contact == '闲鱼' }}>&#xe057; 闲鱼</option>
                    </select>
                </td>
                <td>
                    {{ order.needed_date.strftime('%Y-%m-%d') }}
                    {% if days_left <= 7 and days_left >= 0 and order.status not in ['已完成', '已发货'] %}
                        <br><small style="color: #fa1818;">还有{{ days_left }}天</small>
                    {% endif %}
                    {% if days_left < 0  and order.status not in ['已完成', '已发货'] %}
                        <br><small style="color: #ffffff;font-weight: 600;font-size: 16px;">逾期{{ days_left|abs }}天</small>
                    {% endif %}
                </td>
                <td>{{ order.order_date.strftime('%Y-%m-%d') }}</td>
                <td>
                    <select class="form-select form-select-sm deposit-select" onchange="updateOrderField({{ order.id }}, 'deposit_paid', this.value === 'true'); updateSelectColors();">
                        <option value="false" {{ 'selected' if not order.deposit_paid }}>未付</option>
                        <option value="true" {{ 'selected' if order.deposit_paid }}>已付</option>
                    </select>
                </td>
                <td>¥{{ "%.2f"|format(order.final_amount) }}</td>
                <td>
                    <select class="form-select form-select-sm shipping-select" onchange="updateOrderField({{ order.id }}, 'shipping_included', this.value === 'true'); updateSelectColors();">
                        <option value="false" {{ 'selected' if not order.shipping_included }}>不含邮</option>
                        <option value="true" {{ 'selected' if order.shipping_included }}>含邮</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm blank-select" onchange="updateOrderField({{ order.id }}, 'blank_purchased', this.value === 'true'); updateSelectColors();">
                        <option value="false" {{ 'selected' if not order.blank_purchased }}>未购</option>
                        <option value="true" {{ 'selected' if order.blank_purchased }}>已购</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm cake-box-select" onchange="updateOrderField({{ order.id }}, 'cake_box', this.value); updateSelectColors();">
                        <option value="不需要" {{ 'selected' if order.cake_box == '不需要' }}>不需要</option>
                        <option value="需要" {{ 'selected' if order.cake_box == '需要' }}>需要</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm status-select" onchange="updateOrderField({{ order.id }}, 'status', this.value); updateSelectColors();">
                        <option value="待制作" {{ 'selected' if order.status == '待制作' }}>待制作</option>
                        <option value="制作中" {{ 'selected' if order.status == '制作中' }}>制作中</option>
                        <option value="已完成" {{ 'selected' if order.status == '已完成' }}>已完成</option>
                        <option value="已发货" {{ 'selected' if order.status == '已发货' }}>已发货</option>
                        <option value="已取消" {{ 'selected' if order.status == '已取消' }}>已取消</option>
                    </select>
                </td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{{ url_for('edit_order', id=order.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <a href="{{ url_for('delete_order', id=order.id) }}" 
                           class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('确定要删除这个订单吗？')">
                            <i class="bi bi-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
    <h4 class="mt-3 text-muted">暂无订单</h4>
    <p class="text-muted">点击上方按钮添加第一个订单</p>
</div>
{% endif %}


<!-- 日历视图 -->
<div class="mt-5">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title mb-4"><i class="bi bi-calendar3"></i> 假发制作日历 <span id="calendar-month-count" class="badge ms-2" style="background-color: rgba(13, 110, 253, 0.15); color: #0d6efd; border: 1px solid rgba(13, 110, 253, 0.3); font-weight: 500;"></span></h5>
            <div id="calendar-container">
                <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="changeMonth(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <h6 id="calendar-month-year" class="mb-0"></h6>
                    <button class="btn btn-outline-primary btn-sm" onclick="changeMonth(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">日</div>
                        <div class="calendar-weekday">一</div>
                        <div class="calendar-weekday">二</div>
                        <div class="calendar-weekday">三</div>
                        <div class="calendar-weekday">四</div>
                        <div class="calendar-weekday">五</div>
                        <div class="calendar-weekday">六</div>
                    </div>
                    <div id="calendar-days" class="calendar-days">
                        <!-- 日历日期将通过JavaScript生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图例说明 -->
<div class="mt-4">
    <div class="card">
        <div class="card-body">
            <h6 class="card-title mb-3"><i class="bi bi-palette"></i> 颜色说明</h6>
            <div class="row">
                <div class="col-12">
                    <span class="legend-item legend-item-overdue"><i class="bi bi-emoji-angry"></i> 逾期</span>
                    <span class="legend-item legend-item-very-urgent"><i class="bi bi-emoji-dizzy"></i> 紧急（3天内）</span>
                    <span class="legend-item legend-item-urgent"><i class="bi bi-emoji-frown"></i> 较急（7天内）</span>
                    <span class="legend-item legend-item-completed"><i class="bi bi-emoji-sunglasses"></i> 已完成 </span>
                    <span class="legend-item legend-item-wait"><i class="bi bi-emoji-neutral"></i> 待制作</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <div class="card">
    </div>
</div>

<div class="mt-4">
</div>

{% endblock %}

{% block scripts %}
<script>
// 全局变量
let currentDate = new Date();
let batchMode = false;
let orders = {{ orders_json|safe }};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    updateSelectColors();
    generateCalendar();
    updateCalendarMonthCount();
    
    // 初始化已完成订单的显示状态
    const showCompleted = document.getElementById('showCompleted').checked;
    toggleCompletedOrders(showCompleted);
});

// ==================== 背景设置功能 ====================

// 切换背景设置面板显示
function toggleBackgroundSettings() {
    const panel = document.getElementById('backgroundSettings');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// 处理背景图片上传
function handleBackgroundUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            setBackgroundImage(imageUrl);
            // 保存到localStorage
            localStorage.setItem('backgroundImage', imageUrl);
            localStorage.setItem('backgroundOpacity', document.getElementById('backgroundOpacity').value);
        };
        reader.readAsDataURL(file);
    }
}

// 设置背景图片
function setBackgroundImage(imageUrl) {
    const opacity = document.getElementById('backgroundOpacity').value / 100;
    document.body.style.backgroundImage = `url(${imageUrl})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundRepeat = 'no-repeat';
    document.body.style.backgroundAttachment = 'fixed';
    
    // 添加半透明遮罩
    let overlay = document.querySelector('.background-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'background-overlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, ${1 - opacity});
            pointer-events: none;
            z-index: -1;
        `;
        document.body.appendChild(overlay);
    } else {
        overlay.style.background = `rgba(255, 255, 255, ${1 - opacity})`;
    }
}

// 更新背景透明度
function updateBackgroundOpacity(value) {
    document.getElementById('opacityValue').textContent = value + '%';
    const overlay = document.querySelector('.background-overlay');
    if (overlay) {
        overlay.style.background = `rgba(255, 255, 255, ${1 - value / 100})`;
    }
    // 保存到localStorage
    localStorage.setItem('backgroundOpacity', value);
}

// 移除背景
function removeBackground() {
    document.body.style.backgroundImage = 'none';
    const overlay = document.querySelector('.background-overlay');
    if (overlay) {
        overlay.remove();
    }
    // 清除localStorage
    localStorage.removeItem('backgroundImage');
    localStorage.removeItem('backgroundOpacity');
    // 重置文件输入
    document.getElementById('backgroundImage').value = '';
}

// 页面加载时恢复背景设置
window.addEventListener('load', function() {
    const savedImage = localStorage.getItem('backgroundImage');
    const savedOpacity = localStorage.getItem('backgroundOpacity');
    
    if (savedImage) {
        setBackgroundImage(savedImage);
        if (savedOpacity) {
            document.getElementById('backgroundOpacity').value = savedOpacity;
            document.getElementById('opacityValue').textContent = savedOpacity + '%';
        }
    }
});

// ==================== 订单管理功能 ====================

// 更新订单字段
function updateOrderField(orderId, field, value) {
    fetch(`/api/update_order/${orderId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            field: field,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('订单更新成功');
            // 更新本地orders数据
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order[field] = value;
            }
        } else {
            alert('更新失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('更新失败');
    });
}

// 更新选择框颜色
function updateSelectColors() {
    // 平台选择框颜色
    document.querySelectorAll('.contact-select').forEach(select => {
        select.className = 'form-select form-select-sm contact-select';
        if (select.value === 'QQ') {
            select.classList.add('contact-qq');
        } else if (select.value === '微信') {
            select.classList.add('contact-wechat');
        } else if (select.value === '闲鱼') {
            select.classList.add('contact-xianyu');
        }
    });
    
    // 定金状态颜色
    document.querySelectorAll('.deposit-select').forEach(select => {
        select.className = 'form-select form-select-sm deposit-select';
        if (select.value === 'true') {
            select.classList.add('deposit-paid');
        } else {
            select.classList.add('deposit-unpaid');
        }
    });
    
    // 含邮状态颜色
    document.querySelectorAll('.shipping-select').forEach(select => {
        select.className = 'form-select form-select-sm shipping-select';
        if (select.value === 'true') {
            select.classList.add('shipping-included');
        } else {
            select.classList.add('shipping-not-included');
        }
    });
    
    // 毛坯状态颜色
    document.querySelectorAll('.blank-select').forEach(select => {
        select.className = 'form-select form-select-sm blank-select';
        if (select.value === 'true') {
            select.classList.add('blank-purchased');
        } else {
            select.classList.add('blank-unpurchased');
        }
    });
    
    // 蛋糕盒状态颜色
    document.querySelectorAll('.cake-box-select').forEach(select => {
        select.className = 'form-select form-select-sm cake-box-select';
        if (select.value === '需要') {
            select.classList.add('cake-box-needed');
        } else {
            select.classList.add('cake-box-not-needed');
        }
    });
    
    // 订单状态颜色
    document.querySelectorAll('.status-select').forEach(select => {
        select.className = 'form-select form-select-sm status-select';
        if (select.value === '待制作') {
            select.classList.add('status-pending');
        } else if (select.value === '制作中') {
            select.classList.add('status-in-progress');
        } else if (select.value === '已完成') {
            select.classList.add('status-completed');
        } else if (select.value === '已发货') {
            select.classList.add('status-shipped');
        } else if (select.value === '已取消') {
            select.classList.add('status-cancelled');
        }
    });
}

// ==================== 筛选功能 ====================

// 应用筛选
function applyFilters() {
    const platformFilter = document.getElementById('platformFilter').value;
    const depositFilter = document.getElementById('depositFilter').value;
    const shippingFilter = document.getElementById('shippingFilter').value;
    const blankFilter = document.getElementById('blankFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        let show = true;
        
        // 平台筛选
        if (platformFilter) {
            const contactSelect = row.querySelector('.contact-select');
            if (contactSelect && contactSelect.value !== platformFilter) {
                show = false;
            }
        }
        
        // 定金状态筛选
        if (depositFilter) {
            const depositSelect = row.querySelector('.deposit-select');
            if (depositSelect) {
                const isPaid = depositSelect.value === 'true';
                if ((depositFilter === 'paid' && !isPaid) || (depositFilter === 'unpaid' && isPaid)) {
                    show = false;
                }
            }
        }
        
        // 含邮状态筛选
        if (shippingFilter) {
            const shippingSelect = row.querySelector('.shipping-select');
            if (shippingSelect) {
                const isIncluded = shippingSelect.value === 'true';
                if ((shippingFilter === 'included' && !isIncluded) || (shippingFilter === 'not-included' && isIncluded)) {
                    show = false;
                }
            }
        }
        
        // 毛坯状态筛选
        if (blankFilter) {
            const blankSelect = row.querySelector('.blank-select');
            if (blankSelect) {
                const isPurchased = blankSelect.value === 'true';
                if ((blankFilter === 'purchased' && !isPurchased) || (blankFilter === 'unpurchased' && isPurchased)) {
                    show = false;
                }
            }
        }
        
        // 订单状态筛选
        if (statusFilter) {
            const statusSelect = row.querySelector('.status-select');
            if (statusSelect && statusSelect.value !== statusFilter) {
                show = false;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

// 清除筛选
function clearFilters() {
    document.getElementById('platformFilter').value = '';
    document.getElementById('depositFilter').value = '';
    document.getElementById('shippingFilter').value = '';
    document.getElementById('blankFilter').value = '';
    document.getElementById('statusFilter').value = '';
    
    // 显示所有行
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}

// 切换已完成订单显示
function toggleCompleted() {
    const showCompleted = document.getElementById('showCompleted').checked;
    toggleCompletedOrders(showCompleted);
    
    // 更新URL参数
    const url = new URL(window.location);
    if (showCompleted) {
        url.searchParams.set('show_completed', 'true');
    } else {
        url.searchParams.delete('show_completed');
    }
    window.history.replaceState({}, '', url);
}

// 切换已完成订单显示状态
function toggleCompletedOrders(show) {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        if (row.classList.contains('completed') || row.classList.contains('shipped')) {
            row.style.display = show ? '' : 'none';
        }
    });
}

// ==================== 批量操作功能 ====================

// 切换批量模式
function toggleBatchMode() {
    batchMode = !batchMode;
    const checkboxColumns = document.querySelectorAll('.checkbox-column');
    const toggleBtn = document.getElementById('toggleBatchModeBtn');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const cancelBtn = document.getElementById('cancelBatchModeBtn');
    
    if (batchMode) {
        checkboxColumns.forEach(col => col.style.display = 'table-cell');
        toggleBtn.style.display = 'none';
        batchDeleteBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
    } else {
        checkboxColumns.forEach(col => col.style.display = 'none');
        toggleBtn.style.display = 'inline-block';
        batchDeleteBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        // 清除所有选择
        document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
    }
}

// 取消批量模式
function cancelBatchMode() {
    batchMode = false;
    toggleBatchMode();
}

// 全选/取消全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    
    checkboxes.forEach(cb => {
        // 只选择可见的行
        const row = cb.closest('tr');
        if (row.style.display !== 'none') {
            cb.checked = selectAll.checked;
        }
    });
    
    updateBatchDeleteBtn();
}

// 更新批量删除按钮状态
function updateBatchDeleteBtn() {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    
    if (checkedBoxes.length > 0) {
        batchDeleteBtn.textContent = `批量删除 (${checkedBoxes.length})`;
        batchDeleteBtn.disabled = false;
    } else {
        batchDeleteBtn.textContent = '批量删除';
        batchDeleteBtn.disabled = true;
    }
}

// 批量删除
function batchDelete() {
    const checkedBoxes = document.querySelectorAll('.order-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('请选择要删除的订单');
        return;
    }
    
    if (!confirm(`确定要删除选中的 ${checkedBoxes.length} 个订单吗？`)) {
        return;
    }
    
    const orderIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    fetch('/api/batch_delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_ids: orderIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('删除失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('删除失败');
    });
}

// ==================== 日历功能 ====================

// 生成日历
function generateCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // 更新月份年份显示
    const monthNames = ['一月', '二月', '三月', '四月', '五月', '六月',
                       '七月', '八月', '九月', '十月', '十一月', '十二月'];
    document.getElementById('calendar-month-year').textContent = `${year}年 ${monthNames[month]}`;
    
    // 获取当月第一天和最后一天
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay()); // 从周日开始
    
    const calendarDays = document.getElementById('calendar-days');
    calendarDays.innerHTML = '';
    
    // 生成6周的日期
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const currentDay = new Date(startDate);
            currentDay.setDate(startDate.getDate() + week * 7 + day);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            
            // 判断是否是当前月份
            if (currentDay.getMonth() !== month) {
                dayElement.classList.add('other-month');
            }
            
            // 判断是否是今天
            const today = new Date();
            if (currentDay.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }
            
            // 查找当天的订单
            const dayOrders = orders.filter(order => {
                const orderDate = new Date(order.needed_date);
                return orderDate.toDateString() === currentDay.toDateString();
            });
            
            // 设置日期内容
            let dayContent = `<div class="calendar-date">${currentDay.getDate()}</div>`;
            
            if (dayOrders.length > 0) {
                dayContent += '<div class="calendar-orders">';
                dayOrders.forEach(order => {
                    const today = new Date();
                    const orderDate = new Date(order.needed_date);
                    const daysLeft = Math.ceil((orderDate - today) / (1000 * 60 * 60 * 24));
                    
                    let urgencyClass = 'normal';
                    if (order.status === '已完成' || order.status === '已发货') {
                        urgencyClass = 'completed';
                    } else if (daysLeft < 0) {
                        urgencyClass = 'overdue';
                    } else if (daysLeft <= 3) {
                        urgencyClass = 'very-urgent';
                    } else if (daysLeft <= 7) {
                        urgencyClass = 'urgent';
                    }
                    
                    dayContent += `<div class="calendar-order ${urgencyClass}" onclick="editOrder(${order.id})">${order.cn}</div>`;
                });
                dayContent += '</div>';
            }
            
            dayElement.innerHTML = dayContent;
            calendarDays.appendChild(dayElement);
        }
    }
}

// 切换月份
function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    generateCalendar();
    updateCalendarMonthCount();
}

// 更新日历月份订单数量
function updateCalendarMonthCount() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    const monthOrders = orders.filter(order => {
        const orderDate = new Date(order.needed_date);
        return orderDate.getFullYear() === year && orderDate.getMonth() === month;
    });
    
    document.getElementById('calendar-month-count').textContent = `${monthOrders.length} 个订单`;
}

// 编辑订单
function editOrder(orderId) {
    window.location.href = `/edit/${orderId}`;
}
</script>
{% endblock %}