<!--
07妙妙屋订单管理系统 - 系统设置页面

功能模块：
1. 背景设置面板 - 自定义页面背景图片和透明度
2. 其他系统配置选项
-->
{% extends "dashboard_base.html" %}

{% block title %}系统设置 - 07妙妙屋{% endblock %}

{% block page_title %}系统设置{% endblock %}

{% block extra_css %}
<style>
.settings-section {
    background: rgba(255, 255, 255, 0.75);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 4px 18px 0 rgba(75, 70, 92, 0.1);
    border: none;
    margin-bottom: 30px;
}

.settings-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--dark-color);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.settings-item {
    margin-bottom: 20px;
}

.settings-item:last-child {
    margin-bottom: 0;
}

.form-label {
    font-weight: 500;
    color: var(--dark-color);
    margin-bottom: 8px;
}

.form-control, .form-range {
    border-radius: 10px;
    border: 1px solid #E6EFF5;
    padding: 12px 15px;
}

.form-control:focus, .form-range:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(24, 20, 243, 0.25);
}

.btn {
    border-radius: 10px;
    padding: 12px 24px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: #1410d9;
    border-color: #1410d9;
}

.btn-outline-danger {
    color: var(--danger-color);
    border-color: var(--danger-color);
}

.btn-outline-danger:hover {
    background-color: var(--danger-color);
    border-color: var(--danger-color);
}

.opacity-display {
    font-weight: 600;
    color: var(--primary-color);
}

.preview-area {
    height: 200px;
    border: 2px dashed #E6EFF5;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    overflow: hidden;
}

.preview-placeholder {
    color: var(--secondary-color);
    font-size: 16px;
    text-align: center;
}

.preview-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--dark-color);
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
    <!-- 背景设置 -->
    <div class="settings-section">
        <h5 class="settings-title">
            <i class="bi bi-palette"></i>
            背景设置
        </h5>
        
        <div class="row">
            <!-- 背景图片上传 -->
            <div class="col-md-6">
                <div class="settings-item">
                    <label for="backgroundImage" class="form-label">上传背景图片</label>
                    <input type="file" class="form-control" id="backgroundImage" accept="image/*" onchange="handleBackgroundUpload(event)">
                    <small class="text-muted">支持 JPG、PNG、GIF 格式，建议尺寸 1920x1080</small>
                </div>
                
                <!-- 背景预览 -->
                <div class="settings-item">
                    <label class="form-label">背景预览</label>
                    <div class="preview-area" id="backgroundPreview">
                        <div class="preview-placeholder">
                            <i class="bi bi-image" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
                            暂无背景图片
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 透明度和控制 -->
            <div class="col-md-6">
                <div class="settings-item">
                    <label for="backgroundOpacity" class="form-label">
                        透明度: <span id="opacityValue" class="opacity-display">50%</span>
                    </label>
                    <input type="range" class="form-range" id="backgroundOpacity" min="0" max="100" value="50" oninput="updateBackgroundOpacity(this.value)">
                    <small class="text-muted">调整背景图片的透明度，0% 为完全透明，100% 为完全不透明</small>
                </div>
                
                <div class="settings-item">
                    <label class="form-label">操作</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-danger" onclick="removeBackground()">
                            <i class="bi bi-trash"></i> 移除背景
                        </button>
                        <button class="btn btn-primary" onclick="resetBackground()">
                            <i class="bi bi-arrow-clockwise"></i> 重置设置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 数据管理 -->
    <div class="settings-section">
        <h5 class="settings-title">
            <i class="fa-solid fa-database"></i>
            数据管理
        </h5>
        
        <div class="row">
            <!-- 数据导出 -->
            <div class="col-md-6">
                <div class="settings-item">
                    <label class="form-label">
                        <i class="fa-solid fa-file-export"></i>
                        数据导出
                    </label>
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">选择导出格式</label>
                        <select class="form-select" id="exportFormat">
                            <option value="json">JSON 格式（完整数据）</option>
                            <option value="csv">CSV 格式（Excel兼容）</option>
                        </select>
                    </div>
                    <button class="btn btn-success" onclick="exportData()">
                        <i class="fa-solid fa-download"></i> 导出订单数据
                    </button>
                    <small class="text-muted d-block mt-2">
                        导出所有订单数据到本地文件，用于数据备份和分析
                    </small>
                </div>
            </div>
            
            <!-- 数据导入 -->
            <div class="col-md-6">
                <div class="settings-item">
                    <label class="form-label">
                        <i class="fa-solid fa-file-import"></i>
                        数据导入
                    </label>
                    <div class="mb-3">
                        <label for="importFile" class="form-label">选择JSON文件</label>
                        <input type="file" class="form-control" id="importFile" accept=".json">
                        <small class="text-muted">仅支持JSON格式的订单数据文件</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="clearExisting">
                        <label class="form-check-label" for="clearExisting">
                            清空现有数据后导入
                        </label>
                        <small class="text-muted d-block">
                            <i class="fa-solid fa-triangle-exclamation text-warning"></i>
                            警告：此操作将删除所有现有订单数据
                        </small>
                    </div>
                    <button class="btn btn-primary" onclick="importData()">
                        <i class="fa-solid fa-upload"></i> 导入订单数据
                    </button>
                    <small class="text-muted d-block mt-2">
                        从备份文件恢复订单数据，支持增量导入和完整替换
                    </small>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fa-solid fa-info-circle"></i>
            <strong>数据管理说明：</strong>
            <ul class="mb-0 mt-2">
                <li><strong>导出数据：</strong>JSON格式包含完整字段信息，CSV格式适合Excel分析</li>
                <li><strong>导入数据：</strong>只支持JSON格式，会自动检测重复订单</li>
                <li><strong>安全提示：</strong>导入前建议先导出当前数据作为备份</li>
            </ul>
        </div>
    </div>

    <!-- 其他设置 -->
    <div class="settings-section">
        <h5 class="settings-title">
            <i class="bi bi-gear"></i>
            系统配置
        </h5>
        
        <!-- 宠物模型选择 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="settings-item">
                    <label class="form-label">
                        <i class="bi bi-heart"></i>
                        宠物模型选择
                    </label>
                    <div class="row">
                        <div class="col-md-6">
                            <!-- 搜索和刷新区域 -->
                            <div class="mb-3 d-flex gap-2">
                                <div class="flex-grow-1">
                                    <input type="text" class="form-control" id="spineModelSearch" placeholder="搜索模型名称...">
                                </div>
                                <button type="button" class="btn btn-primary" id="refreshModelsBtn" title="刷新模型列表">
                                    <i class="bi bi-arrow-clockwise"></i> 刷新
                                </button>
                            </div>
                            <select class="form-select" id="spineModelSelect">
                                <option value="">正在加载模型列表...</option>
                            </select>
                            <small class="text-muted">选择您喜欢的宠物模型，更改会立即应用到所有页面</small>
                            <!-- 宠物模式切换 -->
                            <div class="mt-3">
                                <label class="form-label">宠物显示模式</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="petMode" id="petModeFixed" value="fixed" checked>
                                    <label class="form-check-label" for="petModeFixed">
                                        <i class="bi bi-pin-angle"></i> 固定模式
                                    </label>
                                    <small class="text-muted d-block">宠物固定在页面右下角</small>
                                </div>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="radio" name="petMode" id="petModeMoving" value="moving">
                                    <label class="form-check-label" for="petModeMoving">
                                        <i class="bi bi-arrow-left-right"></i> 移动模式
                                    </label>
                                    <small class="text-muted d-block">宠物在页面底部左右移动，支持鼠标交互</small>
                                </div>
                            </div>
                            
                            <!-- 刷新宠物按钮 -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-outline-success btn-sm" id="refreshPetBtn" title="刷新当前页面的宠物">
                                    <i class="bi bi-arrow-repeat"></i> 刷新宠物
                                </button>
                            </div>
                            
                            <!-- 多宠物管理（仅移动模式下显示） -->
                            <div class="mt-3" id="multiPetControls" style="display: none;">
                                <label class="form-label text-info">
                                    <i class="bi bi-collection"></i> 多宠物管理
                                </label>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="addPetBtn" title="添加一个新宠物">
                                        <i class="bi bi-plus-circle"></i> 添加宠物
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm" id="removeLastPetBtn" title="删除最后一个宠物">
                                        <i class="bi bi-dash-circle"></i> 删除最后
                                    </button>
                                    <button type="button" class="btn btn-outline-danger btn-sm" id="clearAllPetsBtn" title="清空所有宠物">
                                        <i class="bi bi-trash"></i> 清空全部
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1">在移动模式下可以同时显示多个宠物</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="spineModelPreview" style="height: 200px; border: 2px dashed #E6EFF5; border-radius: 15px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                <div class="text-muted">
                                    <i class="bi bi-hourglass-split" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                                    正在加载预览...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="row">
            <div class="col-md-6">
                <div class="settings-item">
                    <label class="form-label">默认排序方式</label>
                    <select class="form-select" id="defaultSort">
                        <option value="needed_date">按需求日期</option>
                        <option value="order_date">按下单日期</option>
                        <option value="status">按订单状态</option>
                    </select>
                </div>
                
                <div class="settings-item">
                    <label class="form-label">每页显示订单数</label>
                    <select class="form-select" id="pageSize">
                        <option value="10">10 条</option>
                        <option value="20">20 条</option>
                        <option value="50">50 条</option>
                        <option value="100">100 条</option>
                    </select>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="settings-item">
                    <label class="form-label">紧急订单提醒</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="urgentReminder" checked>
                        <label class="form-check-label" for="urgentReminder">
                            启用紧急订单提醒
                        </label>
                    </div>
                </div>
                
                <div class="settings-item">
                    <label class="form-label">自动保存</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoSave" checked>
                        <label class="form-check-label" for="autoSave">
                            启用自动保存功能
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-outline-secondary" onclick="resetSettings()">
                <i class="bi bi-arrow-clockwise"></i> 重置所有设置
            </button>
            <button class="btn btn-primary" onclick="saveSettings()">
                <i class="bi bi-check-lg"></i> 保存设置
            </button>
        </div>
    </div>
</div>

<script>
// 页面加载时恢复设置
document.addEventListener('DOMContentLoaded', function() {
    loadBackgroundSettings();
    loadSystemSettings();
});

// ==================== 数据管理 - 导出/导入 ====================
async function exportData() {
    try {
        const format = document.getElementById('exportFormat').value;
        const response = await fetch('/api/export_data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ format })
        });
        const result = await response.json();
        if (result.success) {
            showToast('导出成功，正在开始下载…', 'success');
            // 触发下载
            const a = document.createElement('a');
            a.href = result.download_url;
            a.download = result.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } else {
            showToast(result.message || '导出失败', 'error');
        }
    } catch (err) {
        showToast('导出失败：' + (err.message || err), 'error');
    }
}

async function importData() {
    try {
        const fileInput = document.getElementById('importFile');
        if (!fileInput.files || fileInput.files.length === 0) {
            showToast('请先选择要导入的JSON文件', 'warning');
            return;
        }
        const clearExisting = document.getElementById('clearExisting').checked;
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('clear_existing', clearExisting ? 'true' : 'false');
        
        const response = await fetch('/api/import_data', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.success) {
            showToast(result.message || '导入成功', 'success');
        } else {
            showToast(result.message || '导入失败', 'error');
        }
    } catch (err) {
        showToast('导入失败：' + (err.message || err), 'error');
    }
}

// ==================== 背景设置功能 ====================

// 处理背景图片上传
function handleBackgroundUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imageUrl = e.target.result;
            setBackgroundImage(imageUrl);
            updatePreview(imageUrl);
            
            // 保存到localStorage
            localStorage.setItem('backgroundImage', imageUrl);
            localStorage.setItem('backgroundOpacity', document.getElementById('backgroundOpacity').value);
            
            showToast('背景图片已设置', 'success');
        };
        reader.readAsDataURL(file);
    }
}

// 设置背景图片
function setBackgroundImage(imageUrl) {
    const opacity = document.getElementById('backgroundOpacity').value / 100;
    document.documentElement.style.setProperty('--bg-image', `url(${imageUrl})`);
    document.documentElement.style.setProperty('--bg-opacity', opacity);
}

// 更新背景透明度
function updateBackgroundOpacity(value) {
    const opacity = value / 100;
    document.documentElement.style.setProperty('--bg-opacity', opacity);
    document.getElementById('opacityValue').textContent = value + '%';
    
    // 保存到localStorage
    localStorage.setItem('backgroundOpacity', value);
    
    // 更新预览
    const preview = document.getElementById('backgroundPreview');
    if (preview.style.backgroundImage) {
        preview.style.opacity = opacity;
    }
}

// 移除背景
function removeBackground() {
    document.documentElement.style.setProperty('--bg-image', 'none');
    document.documentElement.style.setProperty('--bg-opacity', '0');
    
    // 清除localStorage
    localStorage.removeItem('backgroundImage');
    localStorage.removeItem('backgroundOpacity');
    
    // 重置表单
    document.getElementById('backgroundImage').value = '';
    document.getElementById('backgroundOpacity').value = 50;
    document.getElementById('opacityValue').textContent = '50%';
    
    // 重置预览
    const preview = document.getElementById('backgroundPreview');
    preview.style.backgroundImage = '';
    preview.style.opacity = '1';
    preview.innerHTML = `
        <div class="preview-placeholder">
            <i class="bi bi-image" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
            暂无背景图片
        </div>
    `;
    
    showToast('背景图片已移除', 'success');
}

// 重置背景设置
function resetBackground() {
    removeBackground();
    showToast('背景设置已重置', 'info');
}

// 更新预览
function updatePreview(imageUrl) {
    const preview = document.getElementById('backgroundPreview');
    const opacity = document.getElementById('backgroundOpacity').value / 100;
    
    preview.style.backgroundImage = `url(${imageUrl})`;
    preview.style.opacity = opacity;
    preview.innerHTML = `
        <div class="preview-overlay">
            <i class="bi bi-check-circle" style="font-size: 24px; margin-right: 8px;"></i>
            背景已设置
        </div>
    `;
}

// 加载背景设置
function loadBackgroundSettings() {
    const savedImage = localStorage.getItem('backgroundImage');
    const savedOpacity = localStorage.getItem('backgroundOpacity') || '50';
    
    if (savedImage) {
        setBackgroundImage(savedImage);
        updatePreview(savedImage);
    }
    
    // 更新滑块值
    document.getElementById('backgroundOpacity').value = savedOpacity;
    document.getElementById('opacityValue').textContent = savedOpacity + '%';
}

// ==================== 系统设置功能 ====================

// 加载系统设置
function loadSystemSettings() {
    const defaultSort = localStorage.getItem('defaultSort') || 'needed_date';
    const pageSize = localStorage.getItem('pageSize') || '20';
    const urgentReminder = localStorage.getItem('urgentReminder') !== 'false';
    const autoSave = localStorage.getItem('autoSave') !== 'false';
    
    document.getElementById('defaultSort').value = defaultSort;
    document.getElementById('pageSize').value = pageSize;
    document.getElementById('urgentReminder').checked = urgentReminder;
    document.getElementById('autoSave').checked = autoSave;
}

// 保存系统设置
function saveSettings() {
    const defaultSort = document.getElementById('defaultSort').value;
    const pageSize = document.getElementById('pageSize').value;
    const urgentReminder = document.getElementById('urgentReminder').checked;
    const autoSave = document.getElementById('autoSave').checked;
    
    localStorage.setItem('defaultSort', defaultSort);
    localStorage.setItem('pageSize', pageSize);
    localStorage.setItem('urgentReminder', urgentReminder);
    localStorage.setItem('autoSave', autoSave);
    
    showToast('设置已保存', 'success');
}

// 重置所有设置
function resetSettings() {
    if (confirm('确定要重置所有设置吗？这将清除所有自定义配置。')) {
        // 清除所有设置
        localStorage.removeItem('defaultSort');
        localStorage.removeItem('pageSize');
        localStorage.removeItem('urgentReminder');
        localStorage.removeItem('autoSave');
        
        // 重新加载设置
        loadSystemSettings();
        
        showToast('所有设置已重置', 'info');
    }
}

/**
 * 显示提示消息（支持堆叠；显示3秒后开始渐隐并在0.5秒内移除）
 * @param {string} message - 提示文本
 * @param {'success'|'error'|'warning'|'info'} [type='info'] - 提示类型
 */
function showToast(message, type = 'info') {
    // 获取或创建容器
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        document.body.appendChild(container);
    }

    // 创建提示元素
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
    toast.style.cssText = 'margin-bottom: 10px; min-width: 300px; transition: opacity 0.5s ease-out, transform 0.5s ease-out; opacity: 1; transform: translateX(0);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    container.appendChild(toast);

    // 2.5秒后开始淡出，再移除
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
                if (container.children.length === 0 && container.parentNode) {
                    container.parentNode.removeChild(container);
                }
            }, 500);
        }
    }, 3000);
}

// ==================== 宠物模型选择 ====================
async function loadSpineModels() {
    try {
        const select = document.getElementById('spineModelSelect');
        const res = await fetch('/api/spine_models');
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '加载失败');
        const currentRes = await fetch('/api/spine_model/current');
        const current = await currentRes.json();
        const currentId = current.success ? current.id : '113_cqbw';
        select.innerHTML = '';
        data.models.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = m.name;
            if (m.id === currentId) opt.selected = true;
            opt.dataset.skel = m.skel_path;
            opt.dataset.atlas = m.atlas_path;
            select.appendChild(opt);
        });
        // 初始化预览
        updateSpineModelPreview();
        // 监听切换
        if (!select._changeBound){
            select.addEventListener('change', onSpineModelChange);
            select._changeBound = true;
        }
        // 绑定搜索过滤
        bindModelSearch();
        // 绑定刷新按钮
        bindRefreshButtons();
    } catch (e) {
        showToast('加载模型列表失败：' + e.message, 'error');
    }
}

function bindRefreshButtons(){
    const refreshListBtn = document.getElementById('refreshModelsBtn');
    if (refreshListBtn && !refreshListBtn._bound){
        refreshListBtn.addEventListener('click', async ()=>{
            // 重新加载列表
            await loadSpineModels();
            showToast('模型列表已刷新', 'success');
        });
        refreshListBtn._bound = true;
    }

    const refreshPetBtn = document.getElementById('refreshPetBtn');
    if (refreshPetBtn && !refreshPetBtn._bound){
        refreshPetBtn.addEventListener('click', ()=>{
            const select = document.getElementById('spineModelSelect');
            const opt = select.options[select.selectedIndex];
            if (opt && opt.dataset && opt.dataset.skel && opt.dataset.atlas){
                const skel = safeUrl(opt.dataset.skel);
                const atlas = safeUrl(opt.dataset.atlas);
                const mode = localStorage.getItem('petMode') || 'fixed';
                if (mode === 'moving' && typeof window.refreshMovingPet === 'function'){
                    window.refreshMovingPet(skel, atlas);
                    showToast('移动宠物已刷新', 'success');
                } else if (typeof window.refreshSpinePet === 'function'){
                    window.refreshSpinePet(skel, atlas);
                    showToast('网页宠物已刷新', 'success');
                } else {
                    showToast('未找到刷新方法，稍后再试', 'error');
                }
            }
        });
        refreshPetBtn._bound = true;
    }

    // 绑定多宠物按钮（仅在移动模式显示）
    const addBtn = document.getElementById('addPetBtn');
    const removeLastBtn = document.getElementById('removeLastPetBtn');
    const clearAllBtn = document.getElementById('clearAllPetsBtn');
    const controls = document.getElementById('multiPetControls');

    const applyControlsVisibility = () => {
        const mode = localStorage.getItem('petMode') || 'fixed';
        controls && (controls.style.display = mode === 'moving' ? 'block' : 'none');
    };
    applyControlsVisibility();

    if (addBtn && !addBtn._bound){
        addBtn.addEventListener('click', ()=>{
            const select = document.getElementById('spineModelSelect');
            const opt = select.options[select.selectedIndex];
            if (opt && opt.dataset && opt.dataset.skel && opt.dataset.atlas){
                const skel = safeUrl(opt.dataset.skel);
                const atlas = safeUrl(opt.dataset.atlas);
                if (typeof window.addMovingPet === 'function'){
                    window.addMovingPet(skel, atlas);
                    showToast('已添加一个移动宠物', 'success');
                } else {
                    showToast('当前页面不支持添加移动宠物', 'warning');
                }
            }
        });
        addBtn._bound = true;
    }

    if (removeLastBtn && !removeLastBtn._bound){
        removeLastBtn.addEventListener('click', ()=>{
            if (typeof window.removeLastPet === 'function'){
                window.removeLastPet();
                showToast('已删除最后一个宠物', 'success');
            } else {
                showToast('当前页面不支持删除宠物', 'warning');
            }
        });
        removeLastBtn._bound = true;
    }

    if (clearAllBtn && !clearAllBtn._bound){
        clearAllBtn.addEventListener('click', ()=>{
            if (typeof window.clearAllPets === 'function'){
                window.clearAllPets();
                showToast('已清空所有宠物', 'success');
            } else {
                showToast('当前页面不支持清空宠物', 'warning');
            }
        });
        clearAllBtn._bound = true;
    }
}

function bindModelSearch(){
    const input = document.getElementById('spineModelSearch');
    const select = document.getElementById('spineModelSelect');
    if (!input || !select || input._bound) return;
    input.addEventListener('input', ()=>{
        const keyword = input.value.trim().toLowerCase();
        const options = Array.from(select.options);
        options.forEach(opt=>{
            const name = (opt.textContent || '').toLowerCase();
            opt.hidden = keyword && !name.includes(keyword);
        });
        // 若所有可见项中没有当前选中项，自动选中第一个可见项
        const visible = options.filter(o=>!o.hidden);
        if (visible.length > 0 && visible.every(o=>!o.selected)){
            visible[0].selected = true;
            updateSpineModelPreview();
        }
    });
    input._bound = true;
}

async function onSpineModelChange() {
    const select = document.getElementById('spineModelSelect');
    const id = select.value;
    if (!id) return;
    try {
        const res = await fetch('/api/spine_model/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id })
        });
        const data = await res.json();
        if (data.success) {
            showToast('已切换宠物模型为：' + id, 'success');
            updateSpineModelPreview();
        } else {
            showToast(data.message || '切换失败', 'error');
        }
    } catch (e) {
        showToast('切换失败：' + e.message, 'error');
    }
}

function updateSpineModelPreview() {
    const select = document.getElementById('spineModelSelect');
    const preview = document.getElementById('spineModelPreview');
    const opt = select.options[select.selectedIndex];
    const previewPathRaw = opt && opt.dataset && opt.dataset.atlas ? opt.dataset.atlas.replace('.atlas','') + '.png' : '';
    const previewPath = safeUrl(previewPathRaw);
    if (previewPath) {
        preview.style.background = `url(${previewPath}) center/contain no-repeat`;
        preview.innerHTML = '';
    } else {
        preview.style.background = '#f8f9fa';
        preview.innerHTML = '<div class="text-muted">暂无预览</div>';
    }
}

// 延后到页面ready后加载
window.addEventListener('DOMContentLoaded', function() {
    loadSpineModels();
    initPetModeSettings();
});

// ==================== 宠物模式设置 ====================
function initPetModeSettings() {
    // 加载保存的宠物模式设置
    const savedMode = localStorage.getItem('petMode') || 'fixed';
    const fixedRadio = document.getElementById('petModeFixed');
    const movingRadio = document.getElementById('petModeMoving');
    const controls = document.getElementById('multiPetControls');
    const updateControls = ()=>{ if (controls) controls.style.display = (localStorage.getItem('petMode')||'fixed')==='moving' ? 'block' : 'none'; };
    
    if (savedMode === 'moving') {
        movingRadio.checked = true;
    } else {
        fixedRadio.checked = true;
    }
    updateControls();
    
    // 绑定切换事件
    fixedRadio.addEventListener('change', function() {
        if (this.checked) {
            localStorage.setItem('petMode', 'fixed');
            if (typeof window.toggleMovingPet === 'function') {
                window.toggleMovingPet(false);
            }
            updateControls();
            showToast('已切换到固定宠物模式', 'success');
        }
    });
    
    movingRadio.addEventListener('change', function() {
        if (this.checked) {
            localStorage.setItem('petMode', 'moving');
            // 延迟调用，确保DOM和脚本都准备好了
            setTimeout(() => {
                if (typeof window.toggleMovingPet === 'function') {
                    window.toggleMovingPet(true);
                    updateControls();
                    showToast('已切换到移动宠物模式', 'success');
                } else {
                    showToast('当前页面不支持移动宠物模式', 'warning');
                    // 回退到固定模式
                    fixedRadio.checked = true;
                    localStorage.setItem('petMode', 'fixed');
                    updateControls();
                }
            }, 100);
        }
    });
}

</script>
{% endblock %}