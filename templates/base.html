<!--
07妙妙屋订单管理系统 - 基础模板

功能说明：
- 提供统一的页面布局和样式
- 集成Bootstrap、FontAwesome等UI框架
- 定义订单紧急程度的视觉样式
- 包含响应式设计支持
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 页面标题，子模板可以覆盖 -->
    <title>{% block title %}07妙妙屋{% endblock %}</title>
    
    <!-- 自定义图标字体 -->
    <link href="{{ url_for('static', filename='iconfont.css') }}" rel="stylesheet">
    
    <!-- Bootstrap CSS框架 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- FontAwesome图标库 -->
    <link href="/fontawesome-free-7.0.0-web/css/all.min.css" rel="stylesheet">
    <link href="/fontawesome-free-7.0.0-web/css/fontawesome.css" rel="stylesheet" />
    <link href="/fontawesome-free-7.0.0-web/css/brands.css" rel="stylesheet" />
    <link href="/fontawesome-free-7.0.0-web/css/solid.css" rel="stylesheet" />
    <link href="/fontawesome-free-7.0.0-web/css/sharp-thin.css" rel="stylesheet" />
    <link href="/fontawesome-free-7.0.0-web/css/sharp-duotone-thin.css" rel="stylesheet" />

    <!-- 网站图标 -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='头像_耀骑士临光.png') }}">
    <style>
        /* 全局重置，移除默认的页面外边距，避免顶部空白 */
        html, body { margin: 0; padding: 0; }
        /* ==================== 表格样式 ==================== */
        
        /* 表格行背景色 - 斑马线形式 */
        .table tbody tr {
            /* background-color: white !important;  */
        }

        /* ==================== 图标字体样式 ==================== */
        
        /* 普通图标样式 */
        .iconfont{
            font-size: 16px;
            color: #1aad19;
            text-shadow: none;
        }
        
        /* 大尺寸图标样式（装饰用） */
        .iconfont.large-icon{
            font-size: 200px;
            color: palevioletred;
            text-shadow: 18px 17px 17px gray;
        }
        
        /* ==================== 订单紧急程度样式 ==================== */
        
        /* 紧急订单（3天内）- 黄色系 */
        .urgent:nth-child(even) {
            background-color: rgba(255, 243, 205, 0.9) !important;  /* 淡黄色 - 浅 */
        }
        
        .urgent:nth-child(odd) {
            background-color: rgba(250, 233, 178, 0.9) !important;  /* 淡黄色 - 深 */
        }

        /* 非常紧急订单（7天内）- 红色系 */
        .very-urgent:nth-child(even) {
            background-color: rgba(248,215,218,0.9) !important;  /* 淡红色 - 浅 */
        }
        
        .very-urgent:nth-child(odd) {
            background-color: rgba(253, 199, 203, 0.9) !important;  /* 淡红色 - 深 */
        }

        /* ==================== 订单状态样式 ==================== */
        
        /* 已完成订单 - 绿色系 */
        .completed:nth-child(even) {
            background-color: rgba(212, 237, 218, 0.9) !important;  /* 淡绿色 - 浅 */
        }
        
        .completed:nth-child(odd) {
            background-color: rgba(186, 223, 186, 0.9) !important;  /* 淡绿色 - 深 */
        }

        /* 已发货订单 - 蓝色系 */
        .shipped:nth-child(even) {
            background-color: rgba(209, 236, 241, 0.9) !important;  /* 淡蓝色 - 浅 */
        }
        
        .shipped:nth-child(odd) {
            background-color: rgba(178, 217, 224, 0.9) !important;  /* 淡蓝色 - 深 */
        }

        /* 逾期订单 - 白色背景 */
        .overdue:nth-child(even) {
            background-color: rgba(255,255,255,0.8) !important;
        }
        
        .overdue:nth-child(odd) {
            background-color: rgba(243, 243, 243, 0.8) !important;
        }
        
        /* 排单已过期但未完成/发货的订单 - 深红色背景 */
        .table tbody tr.expired {
            background-color: rgba(216, 89, 102, 0.9) !important;
            color: white !important;
            background-image: none !important;
        }
        
        /* .table tbody tr.expired:hover {
            background-color: #c82333 !important;
            color: white !important;
            background-image: none !important;
        } */
        
        .table tbody tr.expired td {
            /* background-color: #dc3545 !important; */
            color: white !important;
            background-image: none !important;
        }
        
        /* .table tbody tr.expired select,
        .table tbody tr.expired input {
            background-color: rgba(255,255,255,0.9) !important;
            color: #333 !important;
        } */

        
        /* 导航栏样式 */
        .navbar-brand { font-weight: bold; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* 表格样式 */
        .table th { 
            background-color: #f8f9fa; 
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0,123,255,0.05);
        }
        .table {
            min-width: auto;
            width: auto;
        }
        .table td, .table th {
            white-space: nowrap;
            padding: 0.75rem;
            vertical-align: middle;
            text-align: center; /* 表格内容居中显示 */
        }
        .table .form-select-sm {
            min-width: 90px;
        }
        
        /* 表格响应式容器 */
        .table-container {
            width: auto; /* 调整表格容器宽度 */
            max-width: none;
            overflow-x: auto;
            margin: 0 auto 2rem auto; /* 居中显示 */
            padding: 0;
        }
        
        /* 按钮样式 */
        .btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        
        /* 下拉选择框颜色样式 - 动态颜色 */
        .deposit-select.paid {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }
        .deposit-select.unpaid {
            background-color: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
        }
        
        /* 定金选择框选项颜色 */
        .deposit-select option[value="true"] {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        .deposit-select option[value="false"] {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        
        .blank-select.purchased {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }
        .blank-select.unpurchased {
            background-color: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
        }
        
        /* 毛坯选择框选项颜色 */
        .blank-select option[value="true"] {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        .blank-select option[value="false"] {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        
        /* 平台选择框颜色样式 */
        .contact-select option[value="QQ"] {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        .contact-select option[value="微信"] {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        .contact-select option[value="闲鱼"] {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }
        
        /* 平台选择框根据选中值的颜色 */
        .contact-select.qq {
            background-color: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
        }
        .contact-select.wechat {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }
        .contact-select.xianyu {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            color: #856404 !important;
        }
        
        /* Font Awesome图标样式 */
        .contact-select {
            font-family: "Font Awesome 7 Free", "Font Awesome 7 Brands", sans-serif;
        }
        .contact-select option {
            font-family: "Font Awesome 7 Free", "Font Awesome 7 Brands", sans-serif;
            font-weight: 900;
        }
        
        .shipping-select.included {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }
        .shipping-select.not-included {
            background-color: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
        }
        
        /* 含邮选择框选项颜色 */
        .shipping-select option[value="true"] {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        .shipping-select option[value="false"] {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        
        .status-select.pending {
            background-color: #f8d7da !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
        }
        .status-select.in-progress {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            color: #856404 !important;
        }
        .status-select.completed {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
            color: #155724 !important;
        }
        .status-select.shipped {
            background-color: #d1ecf1 !important;
            border-color: #17a2b8 !important;
            color: #0c5460 !important;
        }
        .status-select.cancelled {
            background-color: #f5c6cb !important;
            border-color: #dc3545 !important;
            color: #721c24 !important;
        }
        
        /* 状态选择框选项颜色 */
        .status-select option[value="待制作"] {
            background-color: #f8d7da !important;
            color: #721c24 !important;
        }
        .status-select option[value="制作中"] {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }
        .status-select option[value="已完成"] {
            background-color: #d4edda !important;
            color: #155724 !important;
        }
        .status-select option[value="已发货"] {
            background-color: #d1ecf1 !important;
            color: #0c5460 !important;
        }
        .status-select option[value="已取消"] {
            background-color: #f5c6cb !important;
            color: #721c24 !important;
        }
        
        /* 蛋糕盒选择框样式 */
        .cake-box-select.needed {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
            color: #856404 !important;
        }
        .cake-box-select.not-needed {
            background-color: #e2e3e5 !important;
            border-color: #6c757d !important;
            color: #495057 !important;
        }
        
        .cake-box-select option[value="需要"] {
            background-color: #fff3cd !important;
            color: #856404 !important;
        }
        .cake-box-select option[value="不需要"] {
            background-color: #e2e3e5 !important;
            color: #495057 !important;
        }
        
        /* 页面标题样式 */
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
        }
        
        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .header-actions .btn {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* 背景设置样式 */
        body {
            position: relative;
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-image, none);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            opacity: var(--bg-opacity, 0);
            z-index: -1;
            pointer-events: none;
        }
        
        /* 卡片样式优化 */
        .card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
        }
        .card-body {
            padding: 1.5rem;
        }
        
        /* 统计卡片样式 */
        .stats-card {
            transition: transform 0.2s ease-in-out;
            border: none;
            overflow: hidden;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
        
        /* 渐变卡片样式 - 根据提供的RGB配色 */
        .gradient-card-blue {
            background: rgba(78, 171, 144, 0.8);
            color: white;
        }
        
        .gradient-card-green {
            background: rgba(142, 162, 156, 0.8);
            color: white;
        }
        
        .gradient-card-orange {
            background: rgba(237, 221, 195, 0.8);
            color: #333;
        }
        
        .gradient-card-purple {
            background: rgba(238, 191, 109, 0.8);
            color: white;
        }
        
        .gradient-card-yellow {
            background: rgba(217, 79, 51, 0.8);
            color: white;
        }
        
        .gradient-card-teal {
            background: rgba(175, 101, 94, 0.8);
            color: white;
        }
        
        .stats-icon {
            font-size: 2.5rem;
            opacity: 0.9;
        }
        
        .stats-content h4 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stats-content p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        /* 表格容器样式 */
        .table-responsive {
            width: 200%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* 按钮样式优化 */
        .btn {
            border-radius: 6px;
            font-weight: 500;
        }
        
        /* 图例样式 */
        .legend-item {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 15px;
            font-size: 0.875rem;
            font-weight: 500;
            font-size: 20px;
            white-space: nowrap;
        }

        /* 修改待制作状态颜色 */
        .legend-item-wait {
            background-color: #d4e9a6 !important;
            color: #333 !important;
            
        }

        /* 修改逾期状态颜色 */
        .legend-item-overdue {
            background-color: #ee1f30 !important;
            color: #fff !important;
        }

        /* 修改紧急状态颜色 */
        .legend-item-very-urgent {
            background-color: #cf6e76 !important;
            color: #fff !important;
        }

        /* 修改较急状态颜色 */
        .legend-item-urgent {
            background-color: #ddbd55 !important;
            color: #fff !important;
        }

        /* 修改已完成状态颜色 */
        .legend-item-completed {
            background-color: #90dfec !important;
            color: #333 !important;
        }
        
        /* 日历样式 */
        .calendar-grid {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #f8f9fa;
        }
        
        .calendar-weekday {
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            border-right: 1px solid #dee2e6;
            color: #6c757d;
        }
        
        .calendar-weekday:last-child {
            border-right: none;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        
        .calendar-day {
            min-height: 100px;
            padding: 0.5rem;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            background-color: #fff;
            position: relative;
        }
        
        .calendar-day:last-child {
            border-right: none;
        }
        
        .calendar-day.other-month {
            background-color: #f8f9fa;
            color: #adb5bd;
        }
        
        .calendar-day.today {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }
        
        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .calendar-event {
            background-color: #c7e686;
            color: #333;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-size: 0.9rem;
            margin-bottom: 0.125rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .calendar-event.urgent {
            color: #fff;
            background-color: #ddbd55 !important;  /* 更深的橙色 */
            animation: pulse 1.5s infinite;
        }
        
        .calendar-event.very-urgent {
            color: #fff;
            background-color: #cf6e76 !important;  /* 更深的红色 */
            animation: pulse 1.5s infinite;
        }

        .calendar-event.overdue {
            color: #fff;
            background-color: #ee1f30 !important;  
            animation: pulse 1.5s infinite;
        }

        .calendar-event.completed {
            background-color: #90dfec !important; 
            text-decoration: line-through;  /* 添加中划线 */
            text-decoration-line: line-through;      /* 中划线 */
            text-decoration-color: #000000;          /* 自定义颜色 */
            text-decoration-thickness: 3px;          /* 自定义粗细 */   
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* UI优化 - 圆角效果 */
        .card {
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .table-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-select {
            border-radius: 8px !important;
        }
        
        .btn {
            border-radius: 8px !important;
        }
        
        .btn-group .btn {
            border-radius: 0 !important;
        }
        
        .btn-group .btn:first-child {
            border-top-left-radius: 8px !important;
            border-bottom-left-radius: 8px !important;
        }
        
        .btn-group .btn:last-child {
            border-top-right-radius: 8px !important;
            border-bottom-right-radius: 8px !important;
        }
        
        .table {
            border-radius: 12px;
            overflow: hidden;
        }
        
        .table thead th {
            border-top: none;
            background-color: rgba(248, 249, 250, 0.8); /* 原色彩 + 80% 透明度 */
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            backdrop-filter: blur(5px); /* 可选：添加模糊效果 */
        }
        
        /* 响应式优化 */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.875rem;
            }
            .form-select-sm {
                font-size: 0.75rem;
            }
            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }
            .calendar-event {
                font-size: 0.625rem;
            }
        }

        
        
    </style>
</head>
<body class="{% if is_android %}android-device{% elif is_mobile %}mobile-device{% else %}desktop-device{% endif %}"{% if is_android %} data-platform="android"{% elif is_mobile %} data-platform="mobile"{% else %} data-platform="desktop"{% endif %}>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand text-dark" href="{{ url_for('index') }}">
                <i class="bi bi-scissors"></i> 假毛管理系统
            </a>
        <div class="navbar-nav me-auto">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleBackgroundSettings()">
                <i class="bi bi-image"></i> 背景设置
            </button>
        </div>
        <div class="navbar-nav ms-auto">
            <a class="btn btn-outline-primary me-2" href="{{ url_for('index') }}">订单列表</a>
            <a class="btn btn-primary" href="{{ url_for('add_order') }}">添加订单</a>
        </div>
    </nav>

    <div class="container mt-4 px-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

        /* === Android/Mobile 端适配 === */
        .android-device, .mobile-device {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .android-device .navbar, .mobile-device .navbar {
            padding: 0.5rem 1rem;
        }
        .android-device .card, .mobile-device .card {
            border-radius: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .android-device .card-body, .mobile-device .card-body {
            padding: 1rem;
        }
        .android-device .btn, .mobile-device .btn {
            padding: 0.6rem 0.9rem;
            font-size: 1rem;
        }
        .android-device .table-responsive, .mobile-device .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        .android-device .table td, .android-device .table th,
        .mobile-device .table td, .mobile-device .table th {
            padding: 0.6rem;
            font-size: 0.95rem;
        }
        .android-device .page-header, .mobile-device .page-header {
            border-radius: 12px;
            padding: 1.25rem;
        }
        .android-device .page-title, .mobile-device .page-title { font-size: 1.6rem; }
        .android-device .page-subtitle, .mobile-device .page-subtitle { font-size: 0.95rem; }
        
        /* 更易点触的选择器和控件 */
        .android-device select.form-select, .mobile-device select.form-select,
        .android-device input.form-control, .mobile-device input.form-control {
            min-height: 44px;
        }
        
        /* 背景图在移动端性能优化 */
        body.android-device::before, body.mobile-device::before {
            background-attachment: scroll;
        }
        
        /* Toast/Modal 更大触控区域 */
        .android-device .modal .btn, .mobile-device .modal .btn { min-height: 42px; }
        
        /* 小屏优化 */
        @media (max-width: 576px) {
            .android-device .legend-item, .mobile-device .legend-item {
                font-size: 0.85rem;
                padding: 0.2rem 0.5rem;
            }
        }
        
        
        
    </style>
</head>
<body class="{% if is_android %}android-device{% elif is_mobile %}mobile-device{% else %}desktop-device{% endif %}"{% if is_android %} data-platform="android"{% elif is_mobile %} data-platform="mobile"{% else %} data-platform="desktop"{% endif %}>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand text-dark" href="{{ url_for('index') }}">
                <i class="bi bi-scissors"></i> 假毛管理系统
            </a>
        <div class="navbar-nav me-auto">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleBackgroundSettings()">
                <i class="bi bi-image"></i> 背景设置
            </button>
        </div>
        <div class="navbar-nav ms-auto">
            <a class="btn btn-outline-primary me-2" href="{{ url_for('index') }}">订单列表</a>
            <a class="btn btn-primary" href="{{ url_for('add_order') }}">添加订单</a>
        </div>
    </nav>

    <div class="container mt-4 px-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- 固定位置的宠物容器 -->
    <div id="spine-pet" aria-label="网页宠物" style="position:fixed; right:16px; bottom:16px; width:220px; height:260px; z-index: 1050; pointer-events:auto;"></div>
    
    <!-- 底部移动宠物容器 -->
    <div id="spine-moving-pet" aria-label="移动宠物" style="position:fixed; bottom:0px; left:0px; width:100vw; height:300px; z-index: 1000; pointer-events:none; display:none;">
        <canvas id="spine-moving-canvas" style="width:100%; height:100%; pointer-events:auto;"></canvas>
        <div id="spine-loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#4a90e2; font-size:14px; display:none;">正在加载模型...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('spine_player_js_38') }}?v=2"></script>
    <link rel="stylesheet" href="{{ url_for('spine_player_css_38') }}?v=2">
    <script>
    // 全局函数：处理包含#的URL，进行编码以防止被截断
    window.safeUrl = function(url) {
        if (typeof url === 'string' && url.includes('#')) {
            return url.replace(/#/g, '%23');
        }
        return url;
    };

    (function(){
        // Patch: 自动对 /arkmodels/ 下的图片 URL 中的 # 进行编码，防止被当作片段截断
        try {
            if (!window.__spineImgSrcPatched) {
                const desc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
                if (desc && desc.set && desc.get) {
                    Object.defineProperty(HTMLImageElement.prototype, 'src', {
                        configurable: true,
                        enumerable: true,
                        get: function(){ return desc.get.call(this); },
                        set: function(val){
                            try {
                                if (typeof val === 'string' && val.includes('#') && (val.indexOf('/arkmodels/') !== -1)) {
                                    val = val.replace(/#/g, '%23');
                                }
                            } catch (e) {}
                            return desc.set.call(this, val);
                        }
                    });
                    window.__spineImgSrcPatched = true;
                }
            }
        } catch (e) { /* 忽略补丁失败 */ }

        const containerId = 'spine-pet';
        const isMobile = document.body.classList.contains('android-device') || document.body.classList.contains('mobile-device');
        const scale = isMobile ? 0.8 : 1;
        const playerWidth = isMobile ? 180 : 220;
        const playerHeight = isMobile ? 220 : 260;
        const container = document.getElementById(containerId);
        if (!container) return;
        container.style.width = playerWidth + 'px';
        container.style.height = playerHeight + 'px';

        function initPlayer(skelUrl, atlasUrl){
            try {
                const player = new spine.SpinePlayer(containerId, {
                    skelUrl: skelUrl,
                    atlasUrl: atlasUrl,
                    showControls: false,
                    backgroundColor: '#00000000',
                    alpha: true,
                    preserveDrawingBuffer: false,
                    premultipliedAlpha: true,
                    scale,
                    success: (p) => {
                        const prefer = ['idle', 'Idle', 'stand', 'Stand', 'breath', 'idle_1'];
                        const all = p.animationState.data.skeletonData.animations.map(a=>a.name);
                        let chosen = all.find(a=>prefer.includes(a)) || all[0];
                        p.setAnimation(chosen, true);

                        // 清理旧的点击处理器，避免重复绑定
                        if (window._spinePetClickHandler) {
                            container.removeEventListener('click', window._spinePetClickHandler);
                        }
                        const handler = ()=>{
                            const idx = all.indexOf(chosen);
                            const next = all[(idx + 1) % all.length];
                            chosen = next;
                            p.setAnimation(next, true);
                        };
                        container.addEventListener('click', handler);
                        window._spinePetClickHandler = handler;
                    }
                });
                window._spinePetPlayer = player;
            } catch(e) {
                console.error('Spine player init failed', e);
            }
        }

        // 暴露到全局：根据给定URL刷新宠物
        window.refreshSpinePet = function(newSkelUrl, newAtlasUrl){
            if (!newSkelUrl || !newAtlasUrl) return;
            // 先清空容器DOM，然后重新初始化
            container.innerHTML = '';
            initPlayer(newSkelUrl, newAtlasUrl);
        };
        // 暴露到全局：从后端当前选择获取并刷新
        window.refreshSpinePetFromServer = async function(){
            try {
                const res = await fetch('/api/spine_model/current');
                const data = await res.json();
                if (data && data.success && data.skel_path && data.atlas_path) {
                    window.refreshSpinePet(data.skel_path, data.atlas_path);
                }
            } catch (e) {
                console.error('刷新宠物失败', e);
            }
        };

        const skelUrl = '{{ SPINE_MODEL_SKEL }}';
        const atlasUrl = '{{ SPINE_MODEL_ATLAS }}';
        initPlayer(skelUrl, atlasUrl);
    })();
    
    // ==================== 移动宠物功能 ====================
    (function() {
        // 检查是否支持PIXI.js
        if (typeof PIXI === 'undefined') {
            console.log('PIXI.js not loaded, loading from CDN...');
            const pixiScript = document.createElement('script');
            pixiScript.src = 'https://cdn.jsdelivr.net/npm/pixi.js@6.2.2/dist/browser/pixi.js';
            pixiScript.onload = function() {
                const spineScript = document.createElement('script');
                // 尝试多个CDN源
                const spineCDNs = [
                    'https://cdn.jsdelivr.net/npm/pixi-spine@3.0.16/dist/pixi-spine.umd.js',
                    'https://unpkg.com/pixi-spine@3.0.16/dist/pixi-spine.umd.js',
                    'https://naganeko.pages.dev/chibi-gif/js2/pixi-spine-3.8.umd_all-3.8@3.0.16.js'
                ];
                
                let cdnIndex = 0;
                function tryLoadSpine() {
                    if (cdnIndex >= spineCDNs.length) {
                        console.error('所有PIXI Spine CDN都加载失败');
                        return;
                    }
                    
                    spineScript.src = spineCDNs[cdnIndex];
                    spineScript.onload = initMovingPet;
                    spineScript.onerror = function() {
                        console.warn(`PIXI Spine CDN ${spineCDNs[cdnIndex]} 加载失败，尝试下一个...`);
                        cdnIndex++;
                        tryLoadSpine();
                    };
                    document.head.appendChild(spineScript);
                }
                
                tryLoadSpine();
            };
            document.head.appendChild(pixiScript);
        } else {
            initMovingPet();
        }
        
        let movingApp = null;
        let currentMovingSpine = null;
        let isMoving = false;
        let moveDirection = 1;
        let moveSpeed = 1;
        let isPaused = false;
        let isMouseInteracting = false;
        let originalAnimation = '';
        // 新增：拖拽/下落状态
        let isDragging = false;
        let isFalling = false;
        let velocityY = 0;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let highlightGfx = null;
        // 新增：惯性物理状态与常量
        const gravity = 2200; // px/s^2
        const airFriction = 2.0;       // 空气阻力（越大衰减越快）
        const staticFriction = 900.0;  // 地面静摩擦（px/s^2 等效）
        const resilience = 0.3;        // 水平弹性（0~1）
        const droppedThreshold = 10.0; // 触发“落地一次”的最小高度（px）
        const maxSpeedX = 2500.0;      // 水平最大速度
        const maxSpeedY = 3500.0;      // 垂直最大速度
        let vx = 0, vy = 0;            // 当前速度
        let isOnGround = true;         // 是否在地面
        let dropStartY = null;         // 记录离地时高度
        const pointerSamples = [];     // 拖拽采样用于释放瞬时速度计算
        function pushPointerSample(x, y, tMs) {
          pointerSamples.push({ x, y, t: tMs });
          const cutoff = tMs - 160; // 仅保留最近约160ms
          while (pointerSamples.length && pointerSamples[0].t < cutoff) {
            pointerSamples.shift();
          }
        }
        function computeReleaseVelocity() {
          const n = pointerSamples.length;
          if (n < 2) return { vx: 0, vy: 0 };
          const end = pointerSamples[n - 1];
          let i = n - 2;
          while (i >= 0 && (end.t - pointerSamples[i].t) < 60) i--;
          i = Math.max(0, i);
          const start = pointerSamples[i];
          const dt = Math.max(1, end.t - start.t) / 1000; // s
          return { vx: (end.x - start.x) / dt, vy: (end.y - start.y) / dt };
        }
        function initMovingPet() {
            if (typeof PIXI === 'undefined' || typeof PIXI.spine === 'undefined') {
                console.error('PIXI.js or PIXI.spine not available');
                return;
            }
            
            const canvas = document.getElementById('spine-moving-canvas');
            const container = document.getElementById('spine-moving-pet');
            
            if (!canvas || !container) return;
            
            // 创建PIXI应用
            movingApp = new PIXI.Application({
                view: canvas,
                width: window.innerWidth,
                height: 300,
                backgroundColor: 0x000000,
                backgroundAlpha: 0,
                antialias: true,
                resolution: window.devicePixelRatio || 1,
                autoDensity: true
            });
            // 确保画布不拦截鼠标事件（使用全局代理来处理拖拽）
            if (movingApp && movingApp.view) {
                try { movingApp.view.style.pointerEvents = 'none'; } catch(_) {}
            }
            
            // 窗口大小改变时调整canvas
            window.addEventListener('resize', () => {
                if (movingApp) {
                    movingApp.renderer.resize(window.innerWidth, 300);
                }
            });
        }
        
        function loadMovingSpineModel(skelUrl, atlasUrl) {
            if (!movingApp || !skelUrl || !atlasUrl) return;
            
            const loadingDiv = document.getElementById('spine-loading');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
                loadingDiv.textContent = '正在加载移动模型...';
            }
            
            // 清理当前模型
            if (currentMovingSpine) {
                stopMoving();
                movingApp.stage.removeChild(currentMovingSpine);
                currentMovingSpine.destroy();
                currentMovingSpine = null;
            }
            
            // 使用原始URL，不进行额外编码（因为skelUrl已经在后端正确编码过了）
             const encodedSkelUrl = skelUrl;
            
            // 创建加载器
            const loader = new PIXI.Loader();
            
            // 自定义图片加载器
            const customImageLoaderFactory = function(ldr, namePrefix, baseUrl, imageOptions) {
                if (baseUrl && baseUrl.lastIndexOf('/') !== (baseUrl.length - 1)) {
                    baseUrl += '/';
                }
                return function(line, callback) {
                     const name = namePrefix + line;
                     // 不对line进行额外编码，因为atlas文件中的路径已经是正确的
                     const url = baseUrl + line;
                    const cachedResource = ldr.resources[name];
                    if (cachedResource) {
                        const done = () => {
                            callback(cachedResource.texture.baseTexture);
                        };
                        if (cachedResource.texture) {
                            done();
                        } else {
                            cachedResource.onAfterMiddleware.add(done);
                        }
                    } else {
                        ldr.add(name, url, imageOptions, (resource) => {
                            if (!resource.error) {
                                if (line.indexOf('-pma.') >= 0 && PIXI.ALPHA_MODES && resource.texture && resource.texture.baseTexture) {
                                    resource.texture.baseTexture.alphaMode = PIXI.ALPHA_MODES.PMA;
                                }
                                callback(resource.texture.baseTexture);
                            } else {
                                callback(null);
                            }
                        });
                    }
                }
            };
            
            // 直接使用skel URL，但确保atlas也能正确加载
             loader.add('movingSpine', encodedSkelUrl, {
                 metadata: {
                     imageLoader: customImageLoaderFactory
                 }
             });
             
             // 预加载atlas文件
             loader.add('movingAtlas', atlasUrl, {
                 metadata: {
                     imageLoader: customImageLoaderFactory
                 }
             });
            
            loader.load((loader, resources) => {
                try {
                    if (!resources.movingSpine || !resources.movingSpine.spineData) {
                        throw new Error('Spine数据加载失败');
                    }
                    
                    if (loadingDiv) loadingDiv.style.display = 'none';
                    
                    // 创建Spine对象
                    currentMovingSpine = new PIXI.spine.Spine(resources.movingSpine.spineData);
                    
                    // 设置初始位置和缩放
                    currentMovingSpine.x = movingApp.screen.width / 2;
                    currentMovingSpine.y = movingApp.screen.height;
                    
                    const bounds = currentMovingSpine.getBounds();
                    const scaleX = (movingApp.screen.width * 0.8) / bounds.width;
                    const scaleY = (movingApp.screen.height * 0.8) / bounds.height;
                    const baseScale = Math.min(scaleX, scaleY);
                    const scale = Math.min(baseScale * 2, 3);
                    currentMovingSpine.scale.set(scale);
                    
                    // 重新调整位置
                    currentMovingSpine.x = movingApp.screen.width / 2;
                    currentMovingSpine.y = movingApp.screen.height;
                    
                    // 添加到舞台
                    movingApp.stage.addChild(currentMovingSpine);
                    
                    // 设置交互
                    currentMovingSpine.interactive = true;
                    currentMovingSpine.buttonMode = true;
                    // 改为拖拽触发交互（落地后），不再点击触发
                    currentMovingSpine.cursor = 'grab';
                    
                    // 寻找合适的移动动画
                    const animations = currentMovingSpine.state.data.skeletonData.animations;
                    let defaultAnimation = animations.find(anim => 
                        anim.name.toLowerCase().includes('move') || 
                        anim.name.toLowerCase().includes('walk') ||
                        anim.name.toLowerCase().includes('run')
                    );
                    if (!defaultAnimation) {
                        defaultAnimation = animations[0];
                    }
                    
                    if (defaultAnimation) {
                        currentMovingSpine.state.setAnimation(0, defaultAnimation.name, true);
                        originalAnimation = defaultAnimation.name;
                        isMoving = true;
                        startMoving();
                    }
                    
                    console.log('移动Spine模型加载成功！');
                } catch (e) {
                    console.error('创建移动Spine对象时出错:', e);
                    if (loadingDiv) {
                        loadingDiv.style.display = 'block';
                        loadingDiv.textContent = '错误: ' + (e.message || '未知错误');
                    }
                }
            });
        }
        
        function startMoving() {
            if (!currentMovingSpine || !isMoving) return;
            movingApp.ticker.add(moveModel);
        }
        
        function stopMoving() {
            isMoving = false;
            isPaused = false;
            if (movingApp) {
                movingApp.ticker.remove(moveModel);
            }
        }
        
        // 新增：命中测试与全局拖拽代理（单宠物）
        function toStageXY(e){
          if (!movingApp || !movingApp.view) return {x:0,y:0};
          const rect = movingApp.view.getBoundingClientRect();
          return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }
        function getPetScreenRect(){
          if (!currentMovingSpine || !movingApp || !movingApp.view) return null;
          try {
            const b = currentMovingSpine.getBounds();
            const rect = movingApp.view.getBoundingClientRect();
            const left = rect.left + b.x;
            const top = rect.top + b.y;
            const width = b.width;
            const height = b.height;
            return { left, top, right: left + width, bottom: top + height };
          } catch (_) { return null; }
        }
        function pointInRect(x, y, r){ return r && x >= r.left && x <= r.right && y >= r.top && y <= r.bottom; }
        function drawHighlight(){
          if (!currentMovingSpine || !movingApp) return;
          try {
            const b = currentMovingSpine.getBounds();
            if (!highlightGfx) {
              highlightGfx = new PIXI.Graphics();
              highlightGfx.zIndex = (currentMovingSpine.zIndex || 0) + 1;
              movingApp.stage.addChild(highlightGfx);
              if (movingApp.stage.sortableChildren !== true) movingApp.stage.sortableChildren = true;
            }
            highlightGfx.clear();
            highlightGfx.lineStyle(3, 0xFFD400, 1);
            highlightGfx.drawRect(b.x, b.y, b.width, b.height);
          } catch (_) {}
        }
        function removeHighlight(){
          if (highlightGfx && movingApp && movingApp.stage) {
            try { highlightGfx.clear(); movingApp.stage.removeChild(highlightGfx); } catch (_) {}
            highlightGfx = null;
          }
        }
        function onPointerDown(e){
          const container = document.getElementById('spine-moving-pet');
          if (!container || container.style.display === 'none') return;
          const r = getPetScreenRect();
          if (!pointInRect(e.clientX, e.clientY, r)) return;
          if (!currentMovingSpine) return;
          const { x, y } = toStageXY(e);
          isDragging = true;
          isMouseInteracting = true; // 暂停自动/随机
          vx = 0; vy = 0; // 清零物理速度
          dragOffsetX = currentMovingSpine.x - x;
          dragOffsetY = currentMovingSpine.y - y;
          dropStartY = currentMovingSpine.y;
          pointerSamples.length = 0;
          pushPointerSample(x, y, (self.performance ? performance.now() : Date.now()));
          drawHighlight();
          e.stopPropagation();
          e.preventDefault();
        }
        function onPointerMove(e){
          if (!isDragging || !currentMovingSpine) return;
          const { x, y } = toStageXY(e);
          currentMovingSpine.x = Math.max(0, Math.min(movingApp.screen.width, x + dragOffsetX));
          currentMovingSpine.y = Math.max(0, y + dragOffsetY);
          pushPointerSample(x, y, (self.performance ? performance.now() : Date.now()));
          drawHighlight();
          e.stopPropagation();
          e.preventDefault();
        }
        function onPointerUp(e){
          if (!isDragging) return;
          removeHighlight();
          isDragging = false;
          isMouseInteracting = false;
          const v = computeReleaseVelocity();
          vx = v.vx; vy = v.vy;
          isOnGround = false; // 空中自由运动
          dropStartY = currentMovingSpine ? currentMovingSpine.y : null;
          e.stopPropagation();
          e.preventDefault();
        }
        document.addEventListener('pointerdown', onPointerDown, true);
        document.addEventListener('pointermove', onPointerMove, true);
        document.addEventListener('pointerup', onPointerUp, true);
        document.addEventListener('pointercancel', onPointerUp, true);
        
        // 用惯性物理替换移动更新
        function moveModel() {
          if (!currentMovingSpine || !isMoving) return;
          // 拖拽时不更新物理
          if (isDragging) return;
          const dt = (movingApp && movingApp.ticker && typeof movingApp.ticker.deltaMS === 'number') ? (movingApp.ticker.deltaMS / 1000) : (1/60);
          // 重力（离地才生效）
          if (!isOnGround) {
            vy += gravity * dt;
          }
          // 空气阻力
          const air = Math.max(0, 1 - airFriction * dt);
          vx *= air;
          if (!isOnGround) vy *= air;
          // 地面静摩擦
          if (isOnGround) {
            const sign = Math.sign(vx);
            const mag = Math.max(0, Math.abs(vx) - staticFriction * dt);
            vx = sign * mag;
          }
          // 限速
          vx = Math.max(-maxSpeedX, Math.min(maxSpeedX, vx));
          vy = Math.max(-maxSpeedY, Math.min(maxSpeedY, vy));
          // 积分位置
          currentMovingSpine.x += vx * dt;
          currentMovingSpine.y += vy * dt;
          // 垂直边界/落地
          const groundY = movingApp.screen.height;
          if (currentMovingSpine.y >= groundY) {
            if (!isOnGround && dropStartY != null) {
              const droppedHeight = groundY - dropStartY;
              if (droppedHeight >= droppedThreshold) {
                // 这里可触发一次性落地动画
                try { handleMouseClick && handleMouseClick(); } catch (_) {}
              }
            }
            currentMovingSpine.y = groundY;
            vy = 0;
            isOnGround = true;
          } else if (currentMovingSpine.y < 0) {
            currentMovingSpine.y = 0;
            vy = 0;
            isOnGround = false;
          } else {
            isOnGround = false;
          }
          // 水平边界 + 反弹
          if (currentMovingSpine.x <= 0) {
            currentMovingSpine.x = 0;
            vx = -vx * resilience;
          } else if (currentMovingSpine.x >= movingApp.screen.width) {
            currentMovingSpine.x = movingApp.screen.width;
            vx = -vx * resilience;
          }
          // 朝向
          if (currentMovingSpine.skeleton) {
            if (vx > 5) currentMovingSpine.skeleton.scaleX = Math.abs(currentMovingSpine.skeleton.scaleX);
            else if (vx < -5) currentMovingSpine.skeleton.scaleX = -Math.abs(currentMovingSpine.skeleton.scaleX);
          }
          // 几乎静止时可以保留随机暂停趣味
          if (isOnGround && Math.abs(vx) < 5 && Math.abs(vy) < 5) {
            if (!isMouseInteracting && !isPaused && Math.random() < 0.003) {
              startRandomPause();
            }
          }
        }
        
        function startRandomPause() {
            if (!currentMovingSpine || isPaused || isMouseInteracting) return;
            
            const pauseAnimations = ['interact', 'relax', 'sleep', 'idle', 'stand'];
            const availableAnimations = currentMovingSpine.state.data.skeletonData.animations.filter(anim => 
                pauseAnimations.some(pauseAnim => anim.name.toLowerCase().includes(pauseAnim.toLowerCase()))
            );
            
            if (availableAnimations.length > 0) {
                const randomAnim = availableAnimations[Math.floor(Math.random() * availableAnimations.length)];
                currentMovingSpine.state.setAnimation(0, randomAnim.name, false);
                isPaused = true;
                
                currentMovingSpine.state.addListener({
                    complete: function(entry) {
                        if (entry.animation.name === randomAnim.name && isPaused) {
                            isPaused = false;
                            if (originalAnimation && currentMovingSpine.state.data.skeletonData.findAnimation(originalAnimation)) {
                                currentMovingSpine.state.setAnimation(0, originalAnimation, true);
                            }
                            currentMovingSpine.state.clearListeners();
                        }
                    }
                });
            }
        }
        
        function handleMouseClick() {
            if (!currentMovingSpine || isMouseInteracting) return;
            
            const interactAnimations = currentMovingSpine.state.data.skeletonData.animations.filter(anim => 
                anim.name.toLowerCase().includes('interact')
            );
            
            if (interactAnimations.length > 0) {
                const interactAnim = interactAnimations[0];
                currentMovingSpine.state.setAnimation(0, interactAnim.name, false);
                isMouseInteracting = true;
                isPaused = false;
                
                currentMovingSpine.state.addListener({
                    complete: function(entry) {
                        if (entry.animation.name === interactAnim.name && isMouseInteracting) {
                            isMouseInteracting = false;
                            if (originalAnimation && currentMovingSpine.state.data.skeletonData.findAnimation(originalAnimation)) {
                                currentMovingSpine.state.setAnimation(0, originalAnimation, true);
                            }
                            currentMovingSpine.state.clearListeners();
                        }
                    }
                });
            }
        }
        
        // 暴露全局函数
        window.toggleMovingPet = function(enable) {
            const container = document.getElementById('spine-moving-pet');
            const fixedPet = document.getElementById('spine-pet');
            
            if (enable) {
                container.style.display = 'block';
                fixedPet.style.display = 'none';
                
                if (!movingApp) {
                    initMovingPet();
                }
                
                // 动态获取当前选择的模型
                fetch('/api/spine_model/current')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.skel_path && data.atlas_path) {
                            setTimeout(() => loadMovingSpineModel(data.skel_path, data.atlas_path), 100);
                        } else {
                            // 回退到模板变量
                            const skelUrl = '{{ SPINE_MODEL_SKEL }}';
                            const atlasUrl = '{{ SPINE_MODEL_ATLAS }}';
                            if (skelUrl && atlasUrl) {
                                setTimeout(() => loadMovingSpineModel(skelUrl, atlasUrl), 100);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('获取当前模型失败:', error);
                        // 回退到模板变量
                        const skelUrl = '{{ SPINE_MODEL_SKEL }}';
                        const atlasUrl = '{{ SPINE_MODEL_ATLAS }}';
                        if (skelUrl && atlasUrl) {
                            setTimeout(() => loadMovingSpineModel(skelUrl, atlasUrl), 100);
                        }
                    });
            } else {
                container.style.display = 'none';
                fixedPet.style.display = 'block';
                stopMoving();
            }
        };
        
        window.refreshMovingPet = function(newSkelUrl, newAtlasUrl) {
            if (document.getElementById('spine-moving-pet').style.display !== 'none') {
                loadMovingSpineModel(newSkelUrl, newAtlasUrl);
            }
        };
        
        // 页面加载时检查宠物模式设置
        document.addEventListener('DOMContentLoaded', function() {
            const savedMode = localStorage.getItem('petMode');
            if (savedMode === 'moving') {
                setTimeout(() => {
                    if (typeof window.toggleMovingPet === 'function') {
                        window.toggleMovingPet(true);
                    }
                }, 500);
            }
        });
    })();
    </script>
    
    <!-- 全局背景设置加载 -->
    <script>
    // 加载背景设置
    function loadBackgroundSettings() {
        const savedImage = localStorage.getItem('backgroundImage');
        const savedOpacity = localStorage.getItem('backgroundOpacity') || '50';
        
        if (savedImage) {
            document.documentElement.style.setProperty('--bg-image', `url(${savedImage})`);
            document.documentElement.style.setProperty('--bg-opacity', savedOpacity / 100);
        }
    }
    
    // 页面加载时自动应用背景设置
    document.addEventListener('DOMContentLoaded', loadBackgroundSettings);
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>